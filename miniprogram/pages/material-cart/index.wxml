<!-- ç”³é¢†è½¦é¡µé¢ -->
<view class="container">
  <!-- å¯¼èˆªæ  -->
  <view class="navbar">
    <view class="navbar-content">
      <view class="navbar-left" bindtap="goBack">
        <image src="/assets/icons/common/back.png" class="nav-icon" />
        <text class="nav-title">ç”³é¢†è½¦ï¼ˆ{{cartItems.length}}ï¼‰</text>
      </view>
      <text class="manage-btn" bindtap="toggleManageMode">{{manageMode ? 'å®Œæˆ' : 'ç®¡ç†'}}</text>
    </view>
  </view>

  <!-- æç¤ºä¿¡æ¯ -->
  <view class="tip-banner">
    <image src="/assets/icons/common/info.png" class="tip-icon" />
    <text class="tip-text">æäº¤ç”³é¢†æ—¶å¯é€‰æ‹©å…³è”å·¥å•ï¼Œæ–¹ä¾¿è€—æè¿½è¸ª</text>
  </view>

  <!-- ä¸»å†…å®¹åŒº -->
  <scroll-view class="main-content" scroll-y>
    <!-- å…¨é€‰æ  -->
    <view class="select-all-bar" wx:if="{{cartItems.length > 0}}">
      <view class="checkbox-wrapper" bindtap="toggleSelectAll">
        <view class="checkbox {{selectAll ? 'checked' : ''}}">
          <image wx:if="{{selectAll}}" src="/assets/icons/common/check.png" class="check-icon" />
        </view>
        <text class="select-all-text">å…¨é€‰</text>
      </view>
    </view>

    <!-- ç”³é¢†æ¸…å• -->
    <view class="cart-list" wx:if="{{cartItems.length > 0}}">
      <view wx:for="{{cartItems}}" wx:key="cartKey" class="cart-item {{item.stockWarning ? 'warning' : ''}}">
        <!-- é€‰æ‹©æ¡† -->
        <view class="checkbox-wrapper" bindtap="toggleSelect" data-index="{{index}}">
          <view class="checkbox {{item.selected ? 'checked' : ''}}">
            <image wx:if="{{item.selected}}" src="/assets/icons/common/check.png" class="check-icon" />
          </view>
        </view>
        
        <!-- äº§å“å›¾ç‰‡ -->
        <image class="item-image" 
               src="{{item.image || placeholderImage}}" 
               mode="aspectFill" />
        
        <!-- äº§å“ä¿¡æ¯ -->
        <view class="item-info">
          <text class="item-name">{{item.materialName}}</text>
          <text class="item-spec">{{item.variantLabel}}</text>
          
          <view class="item-footer">
            <!-- åº“å­˜ä¿¡æ¯ -->
            <view class="stock-info">
              <text class="stock-text {{item.stockWarning ? 'warning' : ''}}">  
                åº“å­˜: {{item.stock}}{{item.unit}}
              </text>
              <text wx:if="{{item.stockWarning}}" class="stock-warning">
                âš ï¸ åº“å­˜ä¸è¶³ï¼Œå»ºè®®å‡å°‘æ•°é‡
              </text>
            </view>
            
            <!-- æ•°é‡æ­¥è¿›å™¨ -->
            <view class="quantity-stepper">
              <button class="stepper-btn minus {{item.quantity <= 1 ? 'disabled' : ''}}" 
                      data-index="{{index}}"
                      data-action="minus"
                      bindtap="updateQuantity">
                <image src="/assets/icons/common/minus.png" class="stepper-icon" />
              </button>
              <input type="number" 
                     class="quantity-input" 
                     value="{{item.quantity}}"
                     data-index="{{index}}"
                     bindinput="onQuantityInput" />
              <button class="stepper-btn plus {{item.quantity >= item.stock ? 'disabled' : ''}}" 
                      data-index="{{index}}"
                      data-action="plus"
                      bindtap="updateQuantity">
                <image src="/assets/icons/common/plus.png" class="stepper-icon" />
              </button>
            </view>
          </view>
        </view>
        
        <!-- åˆ é™¤æŒ‰é’® -->
        <view wx:if="{{manageMode}}" 
              class="delete-btn" 
              data-index="{{index}}"
              bindtap="deleteItem">
          <image src="/assets/icons/common/delete.png" class="delete-icon" />
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:else class="empty-state">
      <view class="empty-icon">ğŸ›’</view>
      <text class="empty-text">ç”³é¢†è½¦è¿˜æ˜¯ç©ºçš„</text>
      <text class="empty-hint">èµ¶ç´§å»æ·»åŠ éœ€è¦çš„è€—æå§</text>
      <button class="go-shopping-btn" bindtap="goToMaterialList">å»é€‰è€—æ</button>
    </view>

    <!-- å…³è”å·¥å• -->
    <view class="ticket-section" wx:if="{{cartItems.length > 0}}">
      <view class="section-header">
        <text class="section-title">å…³è”å·¥å•ï¼ˆå¯é€‰ï¼‰</text>
        <text class="section-hint">ä¾¿äºæˆæœ¬è¿½è¸ª</text>
      </view>
      
      <!-- å·²é€‰å·¥å• -->
      <view wx:if="{{selectedTicket}}" class="selected-ticket">
        <view class="ticket-info">
          <view class="ticket-header">
            <text class="ticket-no">{{selectedTicket.ticketNo}}</text>
            <view class="ticket-status status-{{selectedTicket.status}}">
              {{selectedTicket.statusText}}
            </view>
          </view>
          <text class="ticket-title">{{selectedTicket.title}}</text>
          <text class="ticket-customer">å®¢æˆ·: {{selectedTicket.customerName}}</text>
        </view>
        <text class="change-ticket" bindtap="selectTicket">æ›´æ¢</text>
      </view>
      
      <!-- æœªé€‰å·¥å• -->
      <view wx:else class="select-ticket-area">
        <!-- å¿«é€Ÿé€‰æ‹© -->
        <view class="quick-select" wx:if="{{recentTickets.length > 0}}">
          <scroll-view scroll-x class="quick-tickets">
            <view wx:for="{{recentTickets}}" 
                  wx:key="_id" 
                  class="quick-ticket-item"
                  data-ticket="{{item}}"
                  bindtap="quickSelectTicket">
              <text class="quick-ticket-no">{{item.ticketNo}}</text>
              <text class="quick-ticket-title">{{item.title}}</text>
            </view>
          </scroll-view>
        </view>
        
        <button class="select-ticket-btn" bindtap="selectTicket">
          <image src="/assets/icons/common/plus.png" class="btn-icon" />
          <text>é€‰æ‹©å·¥å•</text>
        </button>
      </view>
    </view>

    <!-- å¤‡æ³¨ -->
    <view class="note-section" wx:if="{{cartItems.length > 0}}">
      <text class="section-title">å¤‡æ³¨ä¿¡æ¯</text>
      <textarea class="note-input" 
                placeholder="è¯·è¾“å…¥å¤‡æ³¨ä¿¡æ¯ï¼ˆé€‰å¡«ï¼‰"
                value="{{note}}"
                maxlength="200"
                bindinput="onNoteInput"></textarea>
      <text class="note-count">{{note.length}}/200</text>
    </view>

    <!-- ç”³é¢†é¡»çŸ¥ -->
    <view class="notice-section" wx:if="{{cartItems.length > 0}}">
      <view class="notice-header">
        <image src="/assets/icons/common/info.png" class="notice-icon" />
        <text class="notice-title">ç”³é¢†é¡»çŸ¥</text>
      </view>
      <view class="notice-content">
        <text class="notice-item">1. ç”³é¢†æäº¤åå°†ç›´æ¥æ‰£å‡åº“å­˜ï¼Œæ— éœ€å®¡æ‰¹</text>
        <text class="notice-item">2. è¯·æ ¹æ®å®é™…éœ€æ±‚é€‚é‡ç”³é¢†ï¼Œé¿å…æµªè´¹</text>
        <text class="notice-item">3. å¦‚æœ‰ç´§æ€¥éœ€æ±‚ï¼Œè¯·è”ç³»ç®¡ç†å‘˜</text>
      </view>
    </view>

    <!-- åº•éƒ¨å ä½ -->
    <view class="bottom-placeholder"></view>
  </scroll-view>

  <!-- åº•éƒ¨ç»“ç®—æ  -->
  <view class="checkout-bar" wx:if="{{cartItems.length > 0}}">
    <view class="checkout-info">
      <text class="selected-count">å·²é€‰: {{selectedCount}}ä»¶</text>
      <!-- Managerå¯ä»¥çœ‹æ€»ä»· -->
      <view wx:if="{{isManager}}" class="total-price">
        <text class="price-label">åˆè®¡:</text>
        <text class="price-value">Â¥{{totalPrice}}</text>
      </view>
    </view>
    
    <button class="submit-btn {{selectedCount === 0 ? 'disabled' : ''}}" 
            bindtap="submitRequisition"
            disabled="{{selectedCount === 0}}">
      æäº¤ç”³é¢†
    </button>
  </view>
</view>

<!-- å·¥å•é€‰æ‹©å¼¹çª— -->
<view wx:if="{{showTicketSelector}}" class="modal-mask" bindtap="closeTicketSelector">
  <view class="ticket-selector" catchtap="stopPropagation">
    <view class="selector-header">
      <text class="selector-title">é€‰æ‹©å…³è”å·¥å•</text>
      <image src="/assets/icons/common/close.png" 
             class="close-icon" 
             bindtap="closeTicketSelector" />
    </view>
    
    <!-- æœç´¢æ  -->
    <view class="search-bar">
      <image src="/assets/icons/common/search.png" class="search-icon" />
      <input class="search-input" 
             placeholder="æœç´¢å·¥å•å·ã€å®¢æˆ·ã€é—®é¢˜"
             value="{{ticketSearchKeyword}}"
             bindinput="onTicketSearch" />
    </view>
    
    <!-- Tabåˆ‡æ¢ -->
    <view class="tab-bar">
      <view class="tab-item {{ticketTab === 'my' ? 'active' : ''}}" 
            data-tab="my"
            bindtap="switchTicketTab">æˆ‘çš„å·¥å•</view>
      <view class="tab-item {{ticketTab === 'recent' ? 'active' : ''}}" 
            data-tab="recent"
            bindtap="switchTicketTab">æœ€è¿‘å·¥å•</view>
      <view class="tab-item {{ticketTab === 'all' ? 'active' : ''}}" 
            data-tab="all"
            bindtap="switchTicketTab">å…¨éƒ¨å·¥å•</view>
    </view>
    
    <!-- å·¥å•åˆ—è¡¨ -->
    <scroll-view class="ticket-list" scroll-y>
      <!-- ä¸å…³è”é€‰é¡¹ -->
      <view class="ticket-item no-link" bindtap="selectNoTicket">
        <text class="no-link-text">ä¸å…³è”å·¥å•</text>
      </view>
      
      <view wx:for="{{filteredTickets}}" 
            wx:key="_id" 
            class="ticket-item"
            data-ticket="{{item}}"
            bindtap="onSelectTicket">
        <view class="ticket-content">
          <view class="ticket-header">
            <text class="ticket-no">{{item.ticketNo}}</text>
            <view class="ticket-status status-{{item.status}}">
              {{item.statusText}}
            </view>
          </view>
          <text class="ticket-title">{{item.title}}</text>
          <view class="ticket-meta">
            <text class="ticket-customer">å®¢æˆ·: {{item.customerName}}</text>
            <text class="ticket-time">{{item.createTimeText}}</text>
          </view>
        </view>
      </view>
      
      <view wx:if="{{filteredTickets.length === 0}}" class="no-tickets">
        <text>æš‚æ— å·¥å•</text>
      </view>
    </scroll-view>
  </view>
</view>