<!-- å·¥å•åˆ—è¡¨é¡µé¢ -->
<view class="ticket-list-container">
  <!-- æœç´¢æ  -->
  <view class="search-container">
    <t-search
      model:value="{{searchKeyword}}"
      placeholder="æœç´¢å·¥å•å·ã€æ ‡é¢˜ã€æäº¤äºº..."
      bind:change="onSearchChange"
      bind:submit="onSearch"
    />
  </view>

  <!-- ç­›é€‰æ  - åŒæŠ½å±‰å¼è®¾è®¡ -->
  <view class="filter-container-drawer {{layoutMode}}-layout">
    <!-- ä¸»ç­›é€‰æ ï¼šçŠ¶æ€å’Œæ—¶é—´æŠ½å±‰ -->
    <view class="filter-main-row">
      <!-- çŠ¶æ€é€‰æ‹©æŒ‰é’®ï¼ˆæŠ½å±‰å¼ï¼‰ -->
      <view class="status-selector-wrapper">
        <view 
          class="status-selector-btn {{statusDropdownOpen ? 'open' : ''}} {{currentFilter !== 'all' ? 'active' : ''}}"
          bindtap="toggleStatusDropdown"
        >
          <view class="btn-content">
            <text class="btn-icon">{{currentFilter === 'urgent' ? 'ğŸ”¥' : 'ğŸ“Š'}}</text>
            <text class="btn-text">{{currentFilter === 'all' ? 'å…¨éƒ¨' : currentFilter === 'pending' ? 'å¾…å¤„ç†' : currentFilter === 'processing' ? 'å¤„ç†ä¸­' : currentFilter === 'resolved' ? 'å·²è§£å†³' : currentFilter === 'closed' ? 'å·²å…³é—­' : currentFilter === 'urgent' ? 'ç´§æ€¥' : 'å…¨éƒ¨'}}</text>
          </view>
          <text class="dropdown-icon">â–¼</text>
        </view>
        
        <!-- çŠ¶æ€é€‰æ‹©ä¸‹æ‹‰é¢æ¿ -->
        <view class="status-dropdown-panel" wx:if="{{statusDropdownOpen}}" catchtap="preventClose">
          <view 
            wx:for="{{filterOptions}}" 
            wx:key="value"
            class="status-option {{item.value === currentFilter ? 'selected' : ''}} {{item.value === 'urgent' ? 'urgent-option' : ''}}"
            bindtap="selectStatus"
            data-value="{{item.value}}"
          >
            <text class="option-label">
              {{item.value === 'urgent' ? 'ğŸ”¥ ' : ''}}
              {{item.label}}
            </text>
            <text class="option-count" wx:if="{{item.count > 0}}">({{item.count}})</text>
          </view>
        </view>
      </view>
    
      
      <!-- æ—¶é—´é€‰æ‹©æŒ‰é’®ï¼ˆæŠ½å±‰å¼ï¼‰ -->
      <view class="time-selector-wrapper" wx:if="{{currentFilter !== 'closed'}}">
        <view 
          class="time-selector-btn {{timeDropdownOpen ? 'open' : ''}} {{timeRangeFilter !== 'month' ? 'active' : ''}}"
          bindtap="toggleTimeDropdown"
        >
          <view class="btn-content">
            <text class="btn-icon">ğŸ“…</text>
            <text class="btn-text">{{timeRangeFilter === 'week' ? 'è¿‘7å¤©' : timeRangeFilter === 'month' ? 'è¿‘1æœˆ' : timeRangeFilter === 'halfYear' ? 'è¿‘6æœˆ' : timeRangeFilter === 'year' ? 'è¿‘1å¹´' : timeRangeFilter === 'overYear' ? 'ä¸€å¹´ä»¥ä¸Š' : 'è¿‘1æœˆ'}}</text>
          </view>
          <text class="dropdown-icon">â–¼</text>
        </view>
        
        <!-- æ—¶é—´é€‰æ‹©ä¸‹æ‹‰é¢æ¿ -->
        <view class="time-dropdown-panel" wx:if="{{timeDropdownOpen}}" catchtap="preventClose">
          <view 
            wx:for="{{timeRangeOptions}}" 
            wx:key="value"
            class="time-option {{item.value === timeRangeFilter ? 'selected' : ''}}"
            bindtap="selectTimeRange"
            data-value="{{item.value}}"
          >
            {{item.label}}
          </view>
        </view>
      </view>
    </view>
    
    <!-- å·²å…³é—­å·¥å•æç¤º -->
    <view class="closed-tip" wx:if="{{currentFilter === 'closed'}}">
      <text class="tip-text">ğŸ’¡ ä¸‹æ»‘è‡ªåŠ¨åŠ è½½æ›´æ—©çš„å·²å…³é—­å·¥å•ï¼ˆå½“å‰ï¼š{{closedTimeRange === 'month' ? 'è¿‘1æœˆ' : closedTimeRange === 'halfYear' ? 'è¿‘6æœˆ' : closedTimeRange === 'year' ? 'è¿‘1å¹´' : 'å…¨éƒ¨'}}ï¼‰</text>
    </view>
  </view>

  <!-- å·¥å•åˆ—è¡¨ -->
  <scroll-view 
    scroll-y="{{true}}"
    class="ticket-scroll"
    bindscrolltolower="onLoadMore"
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    enhanced="{{true}}"
    bounces="{{true}}"
    show-scrollbar="{{false}}"
  >
    <view class="ticket-list" wx:if="{{ticketList.length > 0}}">
      <t-swipe-cell 
        wx:for="{{ticketList}}" 
        wx:key="id"
      >
        <view 
          class="ticket-card {{item.priority === 'urgent' ? 'urgent-border' : ''}} {{!item.assigneeOpenid && item.status === 'pending' ? 'pool-ticket' : ''}} {{item.assigneeOpenid && item.assigneeOpenid !== openid ? 'taken' : ''}} {{item.assigneeOpenid === openid ? 'my-ticket' : ''}}"
        >
          <!-- å¯ç‚¹å‡»åŒºåŸŸ - ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… -->
          <view class="card-clickable" bindtap="onTicketClick" data-ticket="{{item}}" data-index="{{index}}">
            <!-- å·¥å•å¤´éƒ¨ -->
            <view class="card-header">
              <view class="header-left">
                <view class="priority-dot priority-{{item.priority}}"></view>
                <text class="ticket-no">#{{item.ticketNo}}</text>
              </view>
              <view class="header-right">
                <t-tag 
                  theme="{{item.status === 'paused' ? 'warning' : item.status === 'pending' ? 'warning' : item.status === 'processing' ? 'primary' : item.status === 'resolved' ? 'success' : 'default'}}"
                  variant="light"
                  size="small"
                >
                  {{statusText[item.status]}}
                </t-tag>
                <t-tag 
                  wx:if="{{item.priority === 'urgent'}}"
                  theme="danger"
                  variant="light"
                  size="small"
                >
                  ç´§æ€¥
                </t-tag>
              </view>
            </view>
            
            <!-- å·¥å•å†…å®¹ -->
            <view class="card-content">
              <view class="content-header">
                <text class="ticket-title">{{item.title}}</text>
                <view class="assignee-tag" wx:if="{{item.assigneeName}}">
                  <image class="assignee-icon" src="/assets/icons/engineer.png" mode="aspectFit"/>
                  <text class="assignee-text">{{item.assigneeName}}</text>
                </view>
              </view>
              <view class="ticket-category">
                <image class="category-icon" src="/assets/icons/category.png" mode="aspectFit"/>
                <text class="category-text">{{item.category}}</text>
              </view>
            </view>
            
            <!-- å·¥å•ä¿¡æ¯ - 2åˆ—å¸ƒå±€ -->
            <view class="card-info">
              <view class="info-row">
                <view class="info-item" wx:if="{{item.company}}">
                  <image class="info-icon" src="/assets/icons/company.png" mode="aspectFit"/>
                  <text class="info-text">{{item.company}}</text>
                </view>
                <view class="info-item">
                  <image class="info-icon" src="/assets/icons/location.png" mode="aspectFit"/>
                  <text class="info-text">{{item.location}}</text>
                </view>
              </view>
              <view class="info-row">
                <view class="info-item">
                  <image class="info-icon" src="/assets/icons/user.png" mode="aspectFit"/>
                  <text class="info-text">{{item.submitter}}</text>
                </view>
                <view class="info-item">
                  <image class="info-icon" src="/assets/icons/time.png" mode="aspectFit"/>
                  <text class="info-text">{{item.createTimeDisplay}}</text>
                </view>
              </view>
            </view>
          </view>
          <!-- ç»“æŸå¯ç‚¹å‡»åŒºåŸŸ -->
          
          <!-- æ“ä½œæŒ‰é’® - ç‹¬ç«‹äºå¯ç‚¹å‡»åŒºåŸŸ -->
          <view class="card-actions">
            
            <!-- åœºæ™¯1ï¼šæœªåˆ†é…å·¥å• - æ˜¾ç¤ºå¼€å§‹å¤„ç†æŒ‰é’® -->
            <button 
              wx:if="{{userRoleGroup === 'å·¥ç¨‹å¸ˆ' && item.realStatus === 'pending' && !item.assigneeOpenid}}"
              class="custom-btn btn-primary"
              catchtap="acceptTicketSafely"
              data-id="{{item.id}}"
            >
              å¼€å§‹å¤„ç†
            </button>
            
            <!-- åœºæ™¯2ï¼šæš‚åœçŠ¶æ€çš„å·¥å• - æ˜¾ç¤ºç»§ç»­å¤„ç†æŒ‰é’® -->
            <button 
              wx:elif="{{item.status === 'paused' && item.assigneeOpenid === openid}}"
              class="custom-btn btn-continue"
              catchtap="continueProcessing"
              data-id="{{item.id}}"
            >
              ç»§ç»­å¤„ç†
            </button>
            
            <!-- åœºæ™¯3ï¼šæˆ‘çš„å·¥å•(processingçŠ¶æ€) - æ˜¾ç¤ºæŸ¥çœ‹è¯¦æƒ…å’Œå®Œæˆå·¥å•ä¸¤ä¸ªæŒ‰é’® -->
            <block wx:elif="{{item.assigneeOpenid === openid && item.status === 'processing'}}">
              <button 
                class="custom-btn btn-detail"
                catchtap="navigateToDetail"
                data-id="{{item.id}}"
              >
                æŸ¥çœ‹è¯¦æƒ…
              </button>
              <button 
                class="custom-btn btn-complete"
                catchtap="completeTicket"
                data-id="{{item.id}}"
              >
                å®Œæˆå·¥å•
              </button>
            </block>
            
            <!-- åœºæ™¯3ï¼šæˆ‘çš„å·¥å•(å·²è§£å†³) - æ˜¾ç¤ºæŸ¥çœ‹è¯¦æƒ… -->
            <button 
              wx:elif="{{item.assigneeOpenid === openid && item.status === 'resolved'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              æŸ¥çœ‹è¯¦æƒ…
            </button>
            
            <!-- åœºæ™¯3.5ï¼šå·²å…³é—­å·¥å• - æ˜¾ç¤ºå·²å…³é—­æ ‡ç­¾ -->
            <t-tag
              wx:elif="{{item.status === 'closed'}}"
              theme="default"
              variant="outline"
              size="medium"
            >
              å·²å…³é—­
            </t-tag>
            
            <!-- åœºæ™¯4ï¼šä»–äººçš„å·¥å• - æ˜¾ç¤ºå·²è¢«æ¥å•æ–‡å­— -->
            <text 
              wx:elif="{{userRoleGroup === 'å·¥ç¨‹å¸ˆ' && item.assigneeOpenid && item.assigneeOpenid !== openid}}"
              class="status-hint"
            >
              å·²è¢«æ¥å•
            </text>
            
            <!-- åœºæ™¯5ï¼šç»ç†è§’è‰² - å§‹ç»ˆæ˜¾ç¤ºæŸ¥çœ‹è¯¦æƒ… -->
            <button 
              wx:elif="{{userRoleGroup === 'ç»ç†'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              æŸ¥çœ‹è¯¦æƒ…
            </button>
            
            <!-- åœºæ™¯6ï¼šæ™®é€šç”¨æˆ·æŸ¥çœ‹è‡ªå·±æäº¤çš„å·¥å• -->
            <button 
              wx:elif="{{userRoleGroup === 'ç”¨æˆ·'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              æŸ¥çœ‹è¯¦æƒ…
            </button>
          </view>
        </view>
      </t-swipe-cell>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <t-empty 
      wx:else
      icon="inbox"
      description="{{emptyText}}"
    >
      <t-button 
        slot="action" 
        theme="primary"
        bind:click="onRefresh"
      >
        åˆ·æ–°åˆ—è¡¨
      </t-button>
    </t-empty>
    
    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && ticketList.length > 0}}">
      <t-loading theme="dots" loading="{{loadingMore}}" text="åŠ è½½ä¸­..." />
    </view>
  </scroll-view>

</view>