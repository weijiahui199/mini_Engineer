<!-- 工单详情页面 -->
<wxs module="utils" src="./utils.wxs"></wxs>
<view class="ticket-detail-container">
  <!-- 自定义导航栏 -->
  <t-navbar 
    title="工单详情" 
    left-arrow
    bind:go-back="handleGoBack"
  />

  <!-- 工单状态条 -->
  <view class="status-bar gradient-bg">
    <view class="status-content">
      <view class="status-left">
        <text class="ticket-number">{{ticketInfo.ticketNo}}</text>
        <t-tag 
          theme="{{ticketInfo.status === 'paused' ? 'warning' : getStatusTheme(ticketInfo.status)}}"
          variant="light"
        >
          {{statusText[ticketInfo.status] || statusText[ticketInfo.realStatus]}}
        </t-tag>
      </view>
      <view class="status-right">
        <t-tag 
          wx:if="{{ticketInfo.priority === 'urgent'}}"
          theme="danger"
          variant="light"
        >
          紧急
        </t-tag>
        <t-tag 
          wx:elif="{{ticketInfo.priority === 'high'}}"
          theme="warning"
          variant="light"
        >
          高优先级
        </t-tag>
      </view>
    </view>
  </view>

  <!-- 工单信息 -->
  <view class="section-container">
    <t-cell-group title="工单信息">
      <t-cell title="问题标题" note="{{ticketInfo.title}}" />
      <t-cell title="问题类型" note="{{ticketInfo.category}}" />
      <t-cell title="提交人" note="{{ticketInfo.submitter}}" />
      <t-cell title="联系电话" note="{{ticketInfo.phone || '未提供'}}" />
      <t-cell title="所在位置" note="{{ticketInfo.location}}" />
      <t-cell title="提交时间" note="{{ticketInfo.createTime}}" />
    </t-cell-group>
  </view>

  <!-- 问题描述 -->
  <view class="section-container">
    <view class="section-title">问题描述</view>
    <view class="description-box">
      <text class="description-text">{{ticketInfo.description || '暂无描述'}}</text>
    </view>
  </view>

  <!-- 附件信息 -->
  <view class="section-container" wx:if="{{ticketInfo.attachments && ticketInfo.attachments.length > 0}}">
    <view class="section-title">相关附件 ({{ticketInfo.attachments.length}})</view>
    <view class="attachment-list">
      <view 
        class="attachment-item" 
        wx:for="{{ticketInfo.attachments}}" 
        wx:key="id"
        bindtap="previewAttachment"
        data-index="{{index}}"
        data-attachment="{{item}}"
      >
        <view class="attachment-icon">
          <!-- 根据文件类型显示不同图标 -->
          <t-icon 
            wx:if="{{item.type === 'image'}}"
            name="image" 
            size="48rpx"
            color="#4299e1"
          />
          <t-icon 
            wx:elif="{{item.mimeType.indexOf('pdf') !== -1}}"
            name="file-pdf" 
            size="48rpx"
            color="#dc2626"
          />
          <t-icon 
            wx:elif="{{item.mimeType.indexOf('word') !== -1 || item.mimeType.indexOf('document') !== -1}}"
            name="file-word" 
            size="48rpx"
            color="#2563eb"
          />
          <t-icon 
            wx:elif="{{item.mimeType.indexOf('excel') !== -1 || item.mimeType.indexOf('spreadsheet') !== -1}}"
            name="file-excel" 
            size="48rpx"
            color="#16a34a"
          />
          <t-icon 
            wx:elif="{{item.mimeType.indexOf('powerpoint') !== -1 || item.mimeType.indexOf('presentation') !== -1}}"
            name="file-powerpoint" 
            size="48rpx"
            color="#ea580c"
          />
          <t-icon 
            wx:else
            name="file" 
            size="48rpx"
            color="#6b7280"
          />
        </view>
        <view class="attachment-info">
          <text class="attachment-name">{{item.originalName || item.name || '附件' + (index + 1)}}</text>
          <view class="attachment-meta">
            <text class="attachment-size">{{utils.formatFileSize(item.size)}}</text>
            <text class="attachment-time">{{utils.formatUploadTime(item.uploadTime)}}</text>
          </view>
        </view>
        <view class="attachment-action">
          <t-icon name="chevron-right" size="24rpx" color="#999" />
        </view>
      </view>
    </view>
  </view>

  <!-- 处理进度时间线 -->
  <view class="section-container">
    <view class="section-title">处理进度</view>
    <view class="timeline">
      <view 
        class="timeline-item {{item.isActive ? 'active' : ''}}" 
        wx:for="{{processTimeline}}" 
        wx:key="id"
      >
        <view class="timeline-dot {{item.isActive ? 'active' : ''}}"></view>
        <view class="timeline-content">
          <view class="timeline-title">{{item.title}}</view>
          <view class="timeline-time">{{item.time}}</view>
          <view class="timeline-desc" wx:if="{{item.description}}">
            {{item.description}}
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 解决方案 -->
  <view class="section-container" wx:if="{{ticketInfo.status === 'processing' || ticketInfo.status === 'resolved'}}">
    <view class="section-title">解决方案</view>
    <view class="solution-box">
      <t-textarea
        model:value="{{solutionText}}"
        placeholder="请描述您的解决方案..."
        maxlength="500"
        indicator
        disabled="{{ticketInfo.status === 'resolved'}}"
      />
    </view>
  </view>


  
  <!-- 底部操作栏 -->
  <view class="bottom-actions safe-bottom" wx:if="{{showActions}}">
    <!-- 待处理状态（真正的待处理，无负责人） -->
    <view wx:if="{{ticketInfo.realStatus === 'pending' && !ticketInfo.assigneeOpenid}}" class="action-group">
      <!-- 工程师：未分配工单显示开始处理按钮 -->
      <button 
        wx:if="{{canAccept}}"
        class="custom-action-btn btn-primary-full"
        bindtap="acceptTicket"
      >
        开始处理
      </button>
    </view>
    
    <!-- 暂停状态（pending但有负责人） -->
    <view wx:elif="{{ticketInfo.status === 'paused' && isAssignee}}" class="action-group">
      <button 
        class="custom-action-btn btn-reject"
        bindtap="rejectTicket"
      >
        退回工单
      </button>
      <button 
        class="custom-action-btn btn-continue"
        bindtap="startProcessing"
      >
        继续处理
      </button>
    </view>
    
    <!-- 处理中状态 -->
    <view wx:elif="{{ticketInfo.status === 'processing' && isAssignee}}" class="action-group">
      <button 
        class="custom-action-btn btn-pause"
        bindtap="pauseProcessing"
      >
        暂停
      </button>
      <button 
        class="custom-action-btn btn-complete-detail"
        bindtap="completeTicket"
      >
        完成工单
      </button>
    </view>
    
    <!-- 已解决状态 -->
    <view wx:elif="{{ticketInfo.status === 'resolved' && isAssignee}}" class="action-group">
      <button 
        class="custom-action-btn btn-reopen"
        bindtap="reopenTicket"
      >
        重新处理
      </button>
      <button 
        class="custom-action-btn btn-close"
        bindtap="closeTicket"
      >
        关闭工单
      </button>
    </view>
    
    <!-- 已关闭状态 - 不显示任何操作按钮 -->
    <view wx:elif="{{ticketInfo.status === 'closed'}}" class="action-group">
      <text style="color: #999; font-size: 28rpx; text-align: center; display: block;">
        工单已关闭，无法进行任何操作
      </text>
    </view>
  </view>


</view>