# Checkpoint 5 错误处理功能测试计划

> 创建时间：2025-08-15  
> 测试目标：验证网络错误处理、重试机制和弱网优化功能

## 📋 测试环境准备

### 1. 开发工具设置
- 打开微信开发者工具
- 启用**网络模拟**功能（调试器 → Network）
- 准备以下网络环境：
  - Normal（正常网络）
  - Slow 3G（慢速网络）
  - Offline（断网）

### 2. 测试账号准备
- 准备一个测试用户账号
- 确保有本地图片用于头像上传测试

## 🧪 测试场景

### 场景一：头像上传重试机制测试

#### 测试步骤：
1. **正常上传测试**
   - 进入个人中心 → 点击头像
   - 选择本地图片
   - 观察：应该正常上传成功

2. **网络中断重试测试**
   - 进入个人中心 → 点击头像
   - 选择图片后立即切换到 **Offline** 模式
   - 预期结果：
     - 显示 "正在重试(1/3)..."
     - 显示 "重试中(2/3)..."
     - 显示 "重试中(3/3)..."
     - 弹出错误对话框："头像上传失败"
     - 提供 "重试" 和 "跳过" 选项

3. **间歇性网络测试**
   - 选择图片上传
   - 在上传过程中快速切换网络状态（Normal → Offline → Normal）
   - 预期结果：
     - 自动重试并最终成功
     - 或显示友好错误提示

#### 验证点：
- [ ] 重试次数正确（最多3次）
- [ ] 重试提示清晰
- [ ] 指数退避生效（延迟逐渐增加）
- [ ] 失败后可手动重试

---

### 场景二：网络错误友好提示测试

#### 测试步骤：
1. **断网提示测试**
   - 切换到 **Offline** 模式
   - 尝试以下操作：
     - 上传头像
     - 保存用户信息
     - 刷新页面数据
   - 预期结果：
     - 立即提示 "网络未连接，请检查网络设置"
     - 不会显示加载动画

2. **超时提示测试**
   - 使用开发者工具的 **Throttling** 设置超长延迟
   - 执行任意网络操作
   - 预期结果（30秒后）：
     - 显示 "操作超时，请稍后重试"
     - 提供明确的操作建议

3. **云函数错误测试**
   - 临时修改云函数名称（制造404错误）
   - 尝试保存用户信息
   - 预期结果：
     - 显示 "功能未部署，请联系管理员"
     - 而不是显示技术性错误

#### 验证点：
- [ ] 错误消息友好易懂
- [ ] 不同错误类型有不同提示
- [ ] 提供操作建议或解决方案
- [ ] 没有暴露技术细节

---

### 场景三：弱网环境优化测试

#### 测试步骤：
1. **2G网络测试**
   - 切换到 **Slow 3G** 或自定义 2G 速度
   - 打开个人中心页面
   - 尝试上传头像
   - 预期结果：
     - 显示警告："当前为2G网络，可能较慢"
     - 上传时提示："当前网络较慢，上传可能需要更长时间"

2. **慢网络加载提示**
   - 设置网络延迟为 5000ms
   - 执行数据加载操作
   - 预期结果（3秒后）：
     - Loading文字变为 "网络较慢，请耐心等待..."
     - 用户知道系统仍在工作

3. **加载状态防闪烁测试**
   - 快速切换页面
   - 观察加载动画
   - 预期结果：
     - 加载动画至少显示500ms
     - 不会出现闪烁

#### 验证点：
- [ ] 弱网检测准确
- [ ] 提示信息及时
- [ ] 加载状态流畅
- [ ] 用户体验连贯

---

### 场景四：头像占位图组件测试

#### 测试步骤：
1. **加载中状态**
   - 清除缓存后进入Dashboard
   - 观察头像加载过程
   - 预期结果：
     - 显示灰色背景 + 加载动画
     - 图片加载完成后平滑过渡

2. **加载失败状态**
   - 修改头像URL为无效地址
   - 刷新页面
   - 预期结果：
     - 显示默认用户图标
     - 不会显示破图

3. **无头像状态**
   - 新用户未设置头像
   - 预期结果：
     - 显示默认用户图标
     - 背景色为 #f0f0f0

#### 验证点：
- [ ] 加载动画流畅
- [ ] 错误处理优雅
- [ ] 默认图标清晰
- [ ] 状态切换平滑

---

## 📊 测试矩阵

| 测试项 | Normal | Slow 3G | Offline | 预期结果 |
|--------|--------|---------|---------|----------|
| 头像上传 | ✅ 成功 | ⚠️ 慢但成功 | ❌ 重试3次后失败 | 符合预期 |
| 用户信息保存 | ✅ 成功 | ⚠️ 显示慢网提示 | ❌ 立即提示断网 | 符合预期 |
| 页面数据加载 | ✅ 正常 | ⚠️ 3秒后提示 | ❌ 使用缓存 | 符合预期 |
| 云函数调用 | ✅ 成功 | ⚠️ 重试后成功 | ❌ 友好错误提示 | 符合预期 |

---

## 🔧 测试工具和命令

### 1. 模拟网络条件
```javascript
// 在控制台执行，模拟断网
wx.offNetworkStatusChange();
wx.onNetworkStatusChange((res) => {
  res.isConnected = false;
  res.networkType = 'none';
});
```

### 2. 查看网络状态
```javascript
// 检查NetworkHandler状态
const NetworkHandler = require('./utils/network-handler');
console.log('网络连接:', NetworkHandler.isNetworkConnected());
console.log('网络类型:', NetworkHandler.getNetworkType());
console.log('是否弱网:', NetworkHandler.isWeakNetwork());
```

### 3. 触发错误测试
```javascript
// 模拟上传失败
NetworkHandler.executeWithRetry(
  () => Promise.reject(new Error('request:fail')),
  { maxRetries: 2 }
).catch(console.error);
```

### 4. 查看重试日志
- 打开控制台
- 筛选 `[NetworkHandler]` 标签
- 观察重试次数和延迟时间

---

## ✅ 测试检查清单

### 功能测试
- [ ] 头像上传自动重试3次
- [ ] 重试使用指数退避算法
- [ ] 超时30秒后显示提示
- [ ] 断网时立即提示
- [ ] 弱网时显示警告
- [ ] 3秒后显示慢网提示
- [ ] 错误消息友好易懂
- [ ] 提供重试选项
- [ ] 失败不阻塞流程

### 用户体验
- [ ] 加载动画流畅
- [ ] 无闪烁现象
- [ ] 状态切换平滑
- [ ] 提示信息清晰
- [ ] 操作可以取消
- [ ] 错误可以恢复

### 边界情况
- [ ] 快速切换网络状态
- [ ] 同时多个请求失败
- [ ] 超长时间等待
- [ ] 极慢网络（<1KB/s）
- [ ] 请求被中断

---

## 📝 测试记录表

| 测试时间 | 测试人 | 测试场景 | 测试结果 | 问题描述 | 备注 |
|---------|--------|---------|---------|---------|------|
| | | | ⭕通过 ❌失败 | | |
| | | | ⭕通过 ❌失败 | | |
| | | | ⭕通过 ❌失败 | | |

---

## 🚨 已知问题和限制

1. **开发工具限制**
   - 开发工具的网络模拟可能与真机有差异
   - 建议在真机上进行最终验证

2. **云函数限制**
   - 云函数超时时间固定
   - 重试可能增加云函数调用次数

3. **用户体验权衡**
   - 重试增加等待时间
   - 需要平衡重试次数和用户等待

---

## 🎯 测试完成标准

1. **功能完整性**：所有测试场景通过
2. **错误覆盖**：主要错误类型都有友好提示
3. **性能表现**：重试不影响正常使用
4. **用户体验**：错误处理不引起困惑

---

*测试计划版本：1.0*  
*最后更新：2025-08-15*