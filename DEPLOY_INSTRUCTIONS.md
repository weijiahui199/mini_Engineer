# 部署说明

## ⚠️ 重要：数据库权限问题

### 问题原因
您的数据库权限规则使用 `doc._openid == auth.openid`，但数据中只有 `openid` 字段，导致权限不匹配。

### 解决方案

#### 方案1：修改数据库权限（推荐）
1. 进入微信云开发控制台
2. 找到 `users` 集合
3. 修改权限规则为：
```json
{
  "read": "doc.openid == auth.openid",
  "write": "doc.openid == auth.openid"
}
```

#### 方案2：保持现有权限
我已经在代码中添加了 `_openid` 字段，所以新创建的用户会同时有 `_openid` 和 `openid` 字段。

对于已存在的用户，需要手动添加 `_openid` 字段：
1. 在云开发控制台的数据库中
2. 找到现有用户记录
3. 添加字段 `_openid`，值与 `openid` 相同

## 云函数部署

由于修改了 `userProfile` 云函数，需要重新部署：

### 方法1：使用微信开发者工具
1. 打开微信开发者工具
2. 在左侧文件树中找到 `cloudfunctions/userProfile` 文件夹
3. 右键点击该文件夹
4. 选择"上传并部署：云端安装依赖"
5. 等待部署完成

### 方法2：使用命令行（如果已配置）
```bash
./uploadCloudFunction.sh userProfile
```

## 重要提示

**必须重新部署 `userProfile` 云函数**，因为我们添加了以下功能：
1. 支持 `avatar` 字段的更新
2. 当用户不存在时自动创建新记录
3. 修复了字段更新逻辑

## 测试步骤

部署完成后，请按以下步骤测试：

1. **清除缓存**
   - 在微信开发者工具中，点击"清缓存" -> "全部清除"

2. **测试用户设置**
   - 进入小程序
   - 在用户设置页面设置头像和昵称
   - 点击保存

3. **验证数据同步**
   - 切换到Dashboard页面，检查头像和昵称是否显示正确
   - 切换到个人中心页面，检查是否同步
   - 下拉刷新，确认数据保持一致

4. **检查控制台日志**
   - 查看是否有 `[UserSetup] 云函数返回结果` 的成功日志
   - 确认没有数据库更新失败的错误

## 问题排查

如果还是无法更新：

1. **检查云函数日志**
   - 在微信云开发控制台查看云函数日志
   - 查看是否有权限错误

2. **检查数据库权限**
   - 确保 `users` 集合的权限设置允许更新
   - 建议设置为"仅创建者可读写"或"所有用户可读，仅创建者可写"

3. **检查openid**
   - 确保 `openid` 正确获取
   - 在控制台查看 `[UserSetup] 准备通过云函数更新用户信息` 的日志

---

更新时间：2025-08-12