<!-- 个人中心页面 -->
<view class="profile-container">
  <!-- 个人信息头部 -->
  <view class="profile-header gradient-bg">
    <view class="header-content">
      <!-- 头像和基本信息 -->
      <view class="user-info">
        <view class="avatar-wrapper">
          <!-- 使用 button 的 open-type="chooseAvatar" 来选择头像 -->
          <button 
            class="avatar-btn" 
            open-type="chooseAvatar" 
            bindchooseavatar="onChooseAvatar"
          >
            <image 
              class="user-avatar" 
              src="{{userInfo.avatar || '/assets/default-avatar.png'}}" 
              mode="aspectFill"
            />
            <view class="avatar-edit-icon">
              <image class="camera-icon" src="/assets/icons/system/camera.png" mode="aspectFit" />
            </view>
          </button>
        </view>
        <view class="user-details">
          <!-- 使用 input 的 type="nickname" 来编辑昵称 -->
          <view class="nickname-edit" wx:if="{{isEditingNickName}}">
            <input 
              type="nickname" 
              class="nickname-input"
              value="{{tempNickName}}"
              placeholder="请输入昵称"
              bindblur="onNickNameBlur"
              bindinput="onNickNameInput"
              bindconfirm="saveNickName"
              focus="{{isEditingNickName}}"
            />
            <image class="check-icon" src="/assets/icons/common/check.png" mode="aspectFit" bindtap="saveNickName" />
          </view>
          <view class="nickname-display" wx:else bindtap="editNickName">
            <text class="user-name">{{userInfo.nickName || userInfo.name || '点击设置昵称'}}</text>
            <image class="edit-icon" src="/assets/icons/common/edit.png" mode="aspectFit" />
          </view>
          <text class="user-role">{{userInfo.roleText}}</text>
          <view class="user-tags">
            <t-tag theme="primary" variant="light" size="small">{{userInfo.department}}</t-tag>
            <t-tag theme="success" variant="light" size="small" wx:if="{{userInfo.isManager}}">管理员</t-tag>
          </view>
        </view>
      </view>
      
      <!-- 统计数据 -->
      <view class="stats-row">
        <view class="stat-item">
          <text class="stat-value">{{stats.totalCompleted}}</text>
          <text class="stat-label">累计完成</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value">{{stats.monthCompleted}}</text>
          <text class="stat-label">本月完成</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value">{{stats.rating}}</text>
          <text class="stat-label">服务评分</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 快捷入口 -->
  <view class="quick-entries">
    <view class="section-title">快捷入口</view>
    <view class="entries-grid">
      <view class="entry-item" bindtap="navigateToTickets">
        <t-icon name="task" size="48rpx" color="#0ea5e9" />
        <text class="entry-label">我的工单</text>
      </view>
      <view class="entry-item" bindtap="goToMaterialStats">
        <t-icon name="box" size="48rpx" color="#10b981" />
        <text class="entry-label">耗材管理</text>
      </view>
      <view class="entry-item" bindtap="goToSettings">
        <t-icon name="setting" size="48rpx" color="#8b5cf6" />
        <text class="entry-label">设置</text>
      </view>
    </view>
  </view>

  <!-- 功能列表 -->
  <view class="function-list">
    <t-cell-group theme="card">
      <t-cell 
        title="个人信息" 
        note="查看和修改个人资料"
        left-icon="user"
        arrow
        bind:click="goToUserInfo"
      />
    </t-cell-group>


    <t-cell-group theme="card">
      <t-cell 
        title="消息通知" 
        note="{{unreadCount > 0 ? unreadCount + '条未读' : '系统消息'}}"
        left-icon="notification"
        arrow
        bind:click="goToNotification"
      >
        <t-badge 
          wx:if="{{unreadCount > 0}}"
          count="{{unreadCount}}"
          slot="note"
          offset="{{[0, 0]}}"
        />
      </t-cell>
      <t-cell 
        title="设置" 
        note="应用设置和偏好"
        left-icon="setting"
        arrow
        bind:click="goToSettings"
      />
      <t-cell 
        title="帮助与反馈" 
        note="使用帮助和问题反馈"
        left-icon="help-circle"
        arrow
        bind:click="goToHelp"
      />
      <t-cell 
        title="关于" 
        note="版本 {{version}}"
        left-icon="info-circle"
        arrow
        bind:click="goToAbout"
      />
    </t-cell-group>
  </view>

  <!-- 退出登录按钮 -->
  <view class="logout-section">
    <t-button 
      theme="danger" 
      size="large"
      block
      bind:tap="logout"
    >
      退出登录
    </t-button>
  </view>

  <!-- 设置弹窗 -->
  <t-popup 
    visible="{{settingsVisible}}" 
    placement="bottom"
    bind:visible-change="handleSettingsChange"
  >
    <view class="settings-dialog">
      <view class="dialog-header">
        <text class="dialog-title">设置</text>
        <t-icon name="close" size="48rpx" bindtap="closeSettings" />
      </view>
      
      <view class="dialog-content">
        <!-- 通知设置 -->
        <view class="setting-group">
          <text class="group-title">通知设置</text>
          <t-cell title="新工单通知">
            <t-switch 
              slot="note"
              value="{{settings.newTicketNotify}}"
              bind:change="onNewTicketNotifyChange"
            />
          </t-cell>
          <t-cell title="工单状态变更">
            <t-switch 
              slot="note"
              value="{{settings.statusChangeNotify}}"
              bind:change="onStatusChangeNotifyChange"
            />
          </t-cell>
          <t-cell title="求助请求">
            <t-switch 
              slot="note"
              value="{{settings.helpRequestNotify}}"
              bind:change="onHelpRequestNotifyChange"
            />
          </t-cell>
        </view>
        
        <!-- 工作设置 -->
        <view class="setting-group">
          <text class="group-title">工作设置</text>
          <t-cell title="自动接单">
            <t-switch 
              slot="note"
              value="{{settings.autoAccept}}"
              bind:change="onAutoAcceptChange"
            />
          </t-cell>
          <t-cell 
            title="最大并行工单数"
            note="{{settings.maxParallelTickets}}个"
            arrow
            bind:click="setMaxParallelTickets"
          />
          <t-cell title="显示地图导航">
            <t-switch 
              slot="note"
              value="{{settings.showNavigation}}"
              bind:change="onShowNavigationChange"
            />
          </t-cell>
        </view>
        
        <!-- 界面设置 -->
        <view class="setting-group">
          <text class="group-title">界面设置</text>
          <t-cell 
            title="主题"
            note="{{settings.theme === 'light' ? '浅色' : '深色'}}"
            arrow
            bind:click="selectTheme"
          />
          <t-cell 
            title="字体大小"
            note="{{settings.fontSize}}"
            arrow
            bind:click="selectFontSize"
          />
        </view>
        
        <!-- 隐私设置 -->
        <view class="setting-group">
          <text class="group-title">隐私设置</text>
          <t-cell title="显示在线状态">
            <t-switch 
              slot="note"
              value="{{settings.showOnlineStatus}}"
              bind:change="onShowOnlineStatusChange"
            />
          </t-cell>
          <t-cell 
            title="清除缓存"
            note="{{cacheSize}}"
            arrow
            bind:click="clearCache"
          />
        </view>
        
        <!-- 测试设置 -->
        <view class="setting-group">
          <text class="group-title">测试功能</text>
          <t-cell title="管理员模式">
            <t-switch 
              slot="note"
              value="{{userInfo.isManager}}"
              bind:change="onManagerModeChange"
            />
          </t-cell>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- 测试功能区域 - 仅用于开发测试 -->
  <view class="test-section" wx:if="{{showTestSection}}">
    <view class="section-header">
      <text class="section-title">开发测试工具</text>
      <text class="test-hint">（仅开发环境可见）</text>
    </view>
    
    <view class="test-card">
      <view class="test-buttons">
        <t-button 
          theme="primary" 
          variant="outline"
          size="medium"
          bind:click="switchToManager"
          block
        >
          🎯 切换为经理角色
        </t-button>
        
        <t-button 
          theme="default" 
          variant="outline"
          size="medium"
          bind:click="switchToEngineer"
          block
        >
          👷 切换为工程师角色
        </t-button>
        
        <t-button 
          theme="warning" 
          variant="outline"
          size="medium"
          bind:click="createTestData"
          block
        >
          📝 创建测试工单
        </t-button>
      </view>
      
      <view class="current-role-info">
        <text class="info-label">当前角色：</text>
        <t-tag theme="{{userInfo.roleGroup === '经理' ? 'success' : 'primary'}}" size="medium">
          {{userInfo.roleGroup || '未设置'}}
        </t-tag>
      </view>
    </view>
    
    <!-- 缓存调试工具 -->
    <view class="test-card" style="margin-top: 20rpx;">
      <view class="section-header">
        <text class="section-title">缓存调试工具</text>
      </view>
      <view class="test-buttons">
        <t-button 
          theme="warning" 
          variant="outline"
          size="medium"
          bind:tap="showCacheInfo"
          block
          style="margin-bottom: 10rpx;"
        >
          🔍 查看缓存信息
        </t-button>
        
        <t-button 
          theme="danger" 
          variant="outline"
          size="medium"
          bind:tap="clearAvatarCache"
          block
          style="margin-bottom: 10rpx;"
        >
          🗑️ 清除头像缓存
        </t-button>
        
        <t-button 
          theme="primary" 
          variant="outline"
          size="medium"
          bind:tap="forceRefreshUser"
          block
        >
          🔄 强制刷新用户信息
        </t-button>
      </view>
    </view>
  </view>

</view>