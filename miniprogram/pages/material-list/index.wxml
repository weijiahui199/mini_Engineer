<!-- 耗材列表页 -->
<view class="container">
  <!-- 顶部导航栏 -->
  <view class="navbar">
    <!-- 第一行：返回按钮和标题 -->
    <view class="navbar-header">
      <view class="navbar-left" bindtap="goBack">
        <image src="/assets/icons/common/back.png" class="nav-icon" />
        <text class="nav-title">耗材管理</text>
      </view>
    </view>
    <!-- 第二行：搜索栏 -->
    <view class="navbar-search">
      <view class="search-bar" bindtap="openSearch">
        <image src="/assets/icons/common/search.png" class="search-icon" />
        <text class="search-placeholder">搜索耗材名称、编号</text>
      </view>
    </view>
  </view>

  <!-- 主体内容 -->
  <view class="main-content">
    <!-- 左侧类目导航 -->
    <view class="category-sidebar">
      <view 
        class="category-item {{currentCategory === 'popular' ? 'active' : ''}}"
        data-category="popular"
        bindtap="switchCategory"
      >
        <text class="category-name">常用</text>
      </view>
      
      <view 
        class="category-item {{currentCategory === 'paper' ? 'active' : ''}}"
        data-category="paper"
        bindtap="switchCategory"
      >
        <text class="category-name">纸张</text>
      </view>
      
      <view 
        class="category-item {{currentCategory === 'writing' ? 'active' : ''}}"
        data-category="writing"
        bindtap="switchCategory"
      >
        <text class="category-name">书写</text>
      </view>
      
      <view 
        class="category-item {{currentCategory === 'print' ? 'active' : ''}}"
        data-category="print"
        bindtap="switchCategory"
      >
        <text class="category-name">打印耗材</text>
      </view>
      
      <view 
        class="category-item {{currentCategory === 'clean' ? 'active' : ''}}"
        data-category="clean"
        bindtap="switchCategory"
      >
        <text class="category-name">清洁/杂项</text>
      </view>
    </view>

    <!-- 右侧产品列表 -->
    <view class="product-list">
      <view class="product-list-container">
        <!-- 产品卡片 -->
        <view wx:for="{{materials}}" wx:key="_id" class="product-card">
          <!-- 缺货标识 -->
          <view wx:if="{{item.stockStatus === 'danger'}}" class="stock-alert-bar"></view>
          
          <!-- 产品图片 -->
          <view class="product-image-wrapper">
            <image 
              wx:if="{{item.defaultImage}}"
              class="product-image" 
              src="{{item.defaultImage}}"
              mode="aspectFill"
            />
            <view wx:else class="product-image-placeholder">
              <text class="placeholder-text">{{item.name[0]}}</text>
            </view>
          </view>
          
          <view class="product-content">
            <view class="product-header">
              <view class="product-info">
                <text class="product-name">{{item.name}}</text>
                <text class="product-spec">{{item.description}}</text>
              </view>
              <view class="stock-badge stock-{{item.stockStatus}}">
                {{item.stockStatusText}}
              </view>
            </view>
            
            <view class="product-footer">
              <view class="product-price-info">
                <!-- Manager可以看价格，Engineer只看库存 -->
                <text class="product-price" wx:if="{{userRole === 'Manager' && item.showPrice}}">¥{{item.priceRange}}</text>
                <text class="product-stock" wx:if="{{userRole === 'Manager'}}">库存: {{item.stockInfo}}</text>
                <!-- Engineer角色：库存信息显示更大 -->
                <text class="product-stock-large" wx:else>库存: {{item.stockInfo}}</text>
              </view>
              
              <!-- 单规格：数量步进器 -->
              <view wx:if="{{item.variants.length === 1}}" class="quantity-stepper">
                <button 
                  class="stepper-btn minus {{item.quantity === 0 ? 'disabled' : ''}}"
                  data-id="{{item._id}}"
                  data-action="minus"
                  bindtap="updateQuantity"
                >
                  <image src="/assets/icons/common/minus.png" class="stepper-icon" />
                </button>
                <input 
                  type="number" 
                  class="quantity-input"
                  value="{{item.quantity || 0}}"
                  data-id="{{item._id}}"
                  bindinput="onQuantityInput"
                />
                <button 
                  class="stepper-btn plus"
                  data-id="{{item._id}}"
                  data-action="plus"
                  bindtap="updateQuantity"
                >
                  <image src="/assets/icons/common/plus.png" class="stepper-icon" />
                </button>
              </view>
              
              <!-- 多规格：选规格按钮 -->
              <button 
                wx:else 
                class="select-spec-btn"
                data-id="{{item._id}}"
                bindtap="selectSpec"
              >
                选规格
              </button>
            </view>
          </view>
        </view>
        
        <!-- 空状态 -->
        <view wx:if="{{!loading && materials.length === 0}}" class="empty-state">
          <text class="empty-icon">📦</text>
          <text class="empty-text">{{currentCategory === 'popular' ? '暂无常用耗材' : '该类目暂无耗材'}}</text>
          <text class="empty-hint">{{currentCategory === 'popular' ? '请切换到其他类目查看' : '请联系管理员添加耗材'}}</text>
        </view>
        
        <!-- 加载中 -->
        <view wx:if="{{loading && materials.length === 0}}" class="loading-state">
          <t-loading theme="circular" size="40rpx" text="加载中..." />
        </view>
      </view>
    </view>
  </view>

  <!-- 底部栏 -->
  <view class="bottom-bar">
    <!-- 左侧：仓库信息 -->
    <view class="warehouse-info">
      <view class="info-item">
        <text class="info-label">当前仓库</text>
        <text class="info-value">{{currentWarehouse}}</text>
      </view>
      <view class="info-divider"></view>
      <view class="info-item">
        <text class="info-label">库存策略</text>
        <text class="info-value">{{stockStrategy}}</text>
      </view>
    </view>
    
    <!-- 右侧：申领车按钮 -->
    <view class="cart-btn" bindtap="goToCart">
      <view class="cart-icon-wrapper">
        <image src="/assets/icons/business/cart.png" class="cart-icon" />
        <view wx:if="{{cartCount > 0}}" class="cart-badge">{{cartCount}}</view>
      </view>
      <view class="cart-info">
        <text class="cart-count">{{cartCount}}件商品</text>
        <!-- Manager可以看总价，Engineer不显示价格 -->
        <text class="cart-total" wx:if="{{userRole === 'Manager'}}">¥{{cartTotal}}</text>
        <text class="cart-action" wx:else>去申领</text>
      </view>
    </view>
  </view>
</view>