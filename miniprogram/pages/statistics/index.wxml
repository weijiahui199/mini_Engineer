<!-- 统计页面 -->
<view class="statistics-container">
  <!-- 自定义导航栏 -->
  <t-navbar 
    title="数据统计"
    left-arrow
    bind:go-back="onBack"
  />

  <!-- 时间选择器 -->
  <view class="time-selector">
    <t-cell-group>
      <t-cell 
        title="统计周期"
        note="{{currentPeriod}}"
        arrow
        bind:click="selectPeriod"
      />
    </t-cell-group>
  </view>

  <!-- 个人统计卡片 -->
  <view class="stats-section">
    <view class="section-title">个人工作统计</view>
    <view class="stats-grid">
      <view class="stat-card gradient-blue">
        <view class="stat-icon">
          <t-icon name="task" size="48rpx" color="white" />
        </view>
        <view class="stat-info">
          <text class="stat-value">{{personalStats.completed}}</text>
          <text class="stat-label">完成工单</text>
        </view>
      </view>
      <view class="stat-card gradient-green">
        <view class="stat-icon">
          <t-icon name="time" size="48rpx" color="white" />
        </view>
        <view class="stat-info">
          <text class="stat-value">{{personalStats.avgTime}}</text>
          <text class="stat-label">平均用时(h)</text>
        </view>
      </view>
      <view class="stat-card gradient-purple">
        <view class="stat-icon">
          <t-icon name="star" size="48rpx" color="white" />
        </view>
        <view class="stat-info">
          <text class="stat-value">{{personalStats.rating}}</text>
          <text class="stat-label">满意度</text>
        </view>
      </view>
      <view class="stat-card gradient-orange">
        <view class="stat-icon">
          <t-icon name="chart-line" size="48rpx" color="white" />
        </view>
        <view class="stat-info">
          <text class="stat-value">{{personalStats.efficiency}}</text>
          <text class="stat-label">效率指数</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 工单类型分布 -->
  <view class="chart-section">
    <view class="section-header">
      <text class="section-title">工单类型分布</text>
      <t-icon name="info-circle" size="36rpx" color="#9ca3af" bindtap="showTypeInfo" />
    </view>
    <view class="chart-card">
      <!-- 饼图占位 -->
      <view class="chart-placeholder">
        <t-icon name="chart-pie" size="80rpx" color="#9ca3af" />
        <text class="placeholder-text">类型分布饼图</text>
      </view>
      <!-- 图例 -->
      <view class="chart-legend">
        <view class="legend-item" wx:for="{{typeDistribution}}" wx:key="type">
          <view class="legend-dot" style="background: {{item.color}}"></view>
          <text class="legend-label">{{item.label}}</text>
          <text class="legend-value">{{item.percentage}}%</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 趋势图表 -->
  <view class="chart-section">
    <view class="section-header">
      <text class="section-title">工作量趋势</text>
      <view class="chart-tabs">
        <t-tag 
          wx:for="{{trendTypes}}" 
          wx:key="value"
          theme="{{item.value === currentTrendType ? 'primary' : 'default'}}"
          variant="{{item.value === currentTrendType ? 'dark' : 'outline'}}"
          size="small"
          bind:click="switchTrendType"
          data-type="{{item.value}}"
        >
          {{item.label}}
        </t-tag>
      </view>
    </view>
    <view class="chart-card">
      <!-- 折线图占位 -->
      <view class="chart-placeholder">
        <t-icon name="chart-line" size="80rpx" color="#9ca3af" />
        <text class="placeholder-text">{{currentTrendType === 'daily' ? '每日' : currentTrendType === 'weekly' ? '每周' : '每月'}}趋势图</text>
      </view>
    </view>
  </view>

  <!-- 团队对比（仅管理员可见） -->
  <view class="chart-section" wx:if="{{isManager}}">
    <view class="section-title">团队成员对比</view>
    <view class="team-comparison">
      <!-- 排行榜 -->
      <view class="ranking-list">
        <view class="ranking-item" wx:for="{{teamRanking}}" wx:key="id">
          <view class="ranking-index ranking-{{index + 1}}">
            {{index + 1}}
          </view>
          <view class="ranking-avatar">
            <image src="{{item.avatar || '/assets/default-avatar.png'}}" mode="aspectFill" />
          </view>
          <view class="ranking-info">
            <text class="ranking-name">{{item.name}}</text>
            <view class="ranking-stats">
              <text class="stat-item">完成: {{item.completed}}</text>
              <text class="stat-item">满意度: {{item.rating}}</text>
            </view>
          </view>
          <view class="ranking-score">
            <text class="score-value">{{item.score}}</text>
            <text class="score-label">综合评分</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 详细数据表格 -->
  <view class="detail-section">
    <view class="section-header">
      <text class="section-title">详细数据</text>
      <text class="section-link" bindtap="viewAllDetails">查看全部</text>
    </view>
    <view class="detail-table">
      <!-- 表头 -->
      <view class="table-header">
        <text class="table-cell">日期</text>
        <text class="table-cell">完成</text>
        <text class="table-cell">进行中</text>
        <text class="table-cell">超时</text>
      </view>
      <!-- 数据行 -->
      <scroll-view scroll-y class="table-body">
        <view class="table-row" wx:for="{{detailData}}" wx:key="date">
          <text class="table-cell">{{item.date}}</text>
          <text class="table-cell text-green">{{item.completed}}</text>
          <text class="table-cell text-blue">{{item.processing}}</text>
          <text class="table-cell text-red">{{item.overtime}}</text>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 导出报表 -->
  <view class="export-section">
    <t-button 
      theme="primary"
      size="large"
      block
      icon="download"
      bind:click="exportReport"
    >
      导出统计报表
    </t-button>
    <view class="export-options">
      <t-checkbox-group 
        value="{{exportOptions}}"
        bind:change="onExportOptionsChange"
      >
        <t-checkbox value="personal" label="个人数据" />
        <t-checkbox value="team" label="团队数据" wx:if="{{isManager}}" />
        <t-checkbox value="charts" label="包含图表" />
      </t-checkbox-group>
    </view>
  </view>

  <!-- 筛选弹窗 -->
  <t-popup 
    visible="{{filterVisible}}" 
    placement="bottom"
    bind:visible-change="handleFilterChange"
  >
    <view class="filter-dialog">
      <view class="dialog-header">
        <text class="dialog-title">数据筛选</text>
        <t-icon name="close" size="48rpx" bindtap="closeFilter" />
      </view>
      
      <view class="dialog-content">
        <!-- 时间范围 -->
        <view class="filter-group">
          <text class="filter-label">时间范围</text>
          <t-radio-group 
            value="{{filterTimeRange}}"
            bind:change="onFilterTimeChange"
          >
            <t-radio value="week" label="最近一周" />
            <t-radio value="month" label="最近一月" />
            <t-radio value="quarter" label="最近一季" />
            <t-radio value="year" label="最近一年" />
            <t-radio value="custom" label="自定义" />
          </t-radio-group>
        </view>
        
        <!-- 工单类型 -->
        <view class="filter-group">
          <text class="filter-label">工单类型</text>
          <t-checkbox-group 
            value="{{filterTicketTypes}}"
            bind:change="onFilterTypesChange"
          >
            <t-checkbox value="hardware" label="硬件故障" />
            <t-checkbox value="software" label="软件问题" />
            <t-checkbox value="network" label="网络故障" />
            <t-checkbox value="account" label="账号权限" />
            <t-checkbox value="other" label="其他" />
          </t-checkbox-group>
        </view>
        
        <!-- 数据维度 -->
        <view class="filter-group" wx:if="{{isManager}}">
          <text class="filter-label">数据维度</text>
          <t-radio-group 
            value="{{filterDimension}}"
            bind:change="onFilterDimensionChange"
          >
            <t-radio value="personal" label="个人数据" />
            <t-radio value="team" label="团队数据" />
            <t-radio value="department" label="部门数据" />
          </t-radio-group>
        </view>
      </view>
      
      <view class="dialog-actions">
        <t-button theme="default" bind:click="resetFilter">重置</t-button>
        <t-button theme="primary" bind:click="applyFilter">应用</t-button>
      </view>
    </view>
  </t-popup>

  <!-- 悬浮按钮 -->
  <t-fab 
    icon="filter"
    bind:click="showFilter"
    style="bottom: 120rpx; right: 32rpx;"
  />
</view>