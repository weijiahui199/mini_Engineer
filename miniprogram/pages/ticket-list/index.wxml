<!-- 工单列表页面 -->
<view class="ticket-list-container">
  <!-- 搜索栏 -->
  <view class="search-container">
    <t-search
      model:value="{{searchKeyword}}"
      placeholder="搜索工单号、标题、提交人..."
      bind:change="onSearchChange"
      bind:submit="onSearch"
    />
  </view>

  <!-- 筛选栏 -->
  <view class="filter-container">
    <!-- 负责人显示 -->
    <view class="assignee-display" wx:if="{{userRoleGroup === '经理' || currentAssignee === 'my'}}">
      <text class="assignee-label">负责人：</text>
      <text class="assignee-value">
        <block wx:if="{{currentAssignee === 'all'}}">全部</block>
        <block wx:elif="{{currentAssignee === 'my'}}">我负责的</block>
        <block wx:else>
          <block wx:for="{{assigneeOptions}}" wx:key="value">
            <text wx:if="{{item.value === currentAssignee}}">{{item.label}}</text>
          </block>
        </block>
      </text>
    </view>
    
    <scroll-view scroll-x class="filter-scroll">
      <view class="filter-tabs">
        <t-tag 
          wx:for="{{filterOptions}}" 
          wx:key="value"
          theme="{{item.value === currentFilter ? 'primary' : 'default'}}"
          variant="{{item.value === currentFilter ? 'dark' : 'outline'}}"
          bind:click="onFilterClick"
          data-value="{{item.value}}"
        >
          {{item.label}}
          <text wx:if="{{item.count > 0}}" class="filter-count">({{item.count}})</text>
        </t-tag>
        
        <t-tag 
          theme="default"
          variant="outline"
          bind:click="showMoreFilters"
        >
          <text class="filter-icon">⚙️</text>
          更多
        </t-tag>
      </view>
    </scroll-view>
  </view>

  <!-- 统计信息 -->
  <view class="stats-bar" wx:if="{{showStats}}">
    <view class="stats-content">
      <text class="stats-text">今日工单: {{todayStats.assigned}}个</text>
      <text class="stats-highlight">完成率: {{todayStats.completionRate}}%</text>
    </view>
  </view>

  <!-- 工单列表 -->
  <scroll-view 
    scroll-y="{{true}}"
    class="ticket-scroll"
    bindscrolltolower="onLoadMore"
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    enhanced="{{true}}"
    bounces="{{true}}"
    show-scrollbar="{{false}}"
  >
    <view class="ticket-list" wx:if="{{ticketList.length > 0}}">
      <t-swipe-cell 
        wx:for="{{ticketList}}" 
        wx:key="id"
        right="{{getSwipeActions(item)}}"
      >
        <view 
          class="ticket-card {{item.priority === 'urgent' ? 'urgent-border' : ''}}"
          bindtap="navigateToDetail"
          data-id="{{item.id}}"
        >
          <!-- 工单头部 -->
          <view class="card-header">
            <view class="header-left">
              <view class="priority-dot priority-{{item.priority}}"></view>
              <text class="ticket-no">{{item.ticketNo}}</text>
              <t-tag 
                wx:if="{{item.priority === 'urgent'}}"
                theme="danger"
                variant="light"
                size="small"
              >
                紧急
              </t-tag>
              <t-tag 
                wx:elif="{{item.priority === 'high'}}"
                theme="warning"
                variant="light"
                size="small"
              >
                高
              </t-tag>
            </view>
            <view class="header-right">
              <t-tag 
                theme="{{getStatusTheme(item.status)}}"
                variant="light"
                size="small"
              >
                {{statusText[item.status]}}
              </t-tag>
            </view>
          </view>
          
          <!-- 工单内容 -->
          <view class="card-content">
            <text class="ticket-title">{{item.title}}</text>
            <text class="ticket-category">{{item.category}}</text>
          </view>
          
          <!-- 工单信息 -->
          <view class="card-info">
            <view class="info-item">
              <text class="info-icon">👤</text>
              <text class="info-text">{{item.submitter}}</text>
            </view>
            <view class="info-item">
              <text class="info-icon">📍</text>
              <text class="info-text">{{item.location}}</text>
            </view>
            <view class="info-item">
              <text class="info-icon">⏰</text>
              <text class="info-text">{{item.createTime}}</text>
            </view>
            <view class="info-item" wx:if="{{item.assigneeName && userRoleGroup === '经理' && currentAssignee === 'all'}}">
              <text class="info-icon">👷</text>
              <text class="info-text">{{item.assigneeName}}</text>
            </view>
          </view>
          
          <!-- 操作按钮 -->
          <view class="card-actions">
            <t-button 
              wx:if="{{item.status === 'pending' && !item.assigned}}"
              theme="primary"
              size="small"
              bind:click="acceptTicket"
              data-id="{{item.id}}"
            >
              接受工单
            </t-button>
            <t-button 
              wx:elif="{{item.status === 'pending' && item.assigned}}"
              theme="primary"
              size="small"
              bind:click="startProcessing"
              data-id="{{item.id}}"
            >
              开始处理
            </t-button>
            <t-button 
              wx:elif="{{item.status === 'processing'}}"
              theme="default"
              size="small"
              bind:click="continueProcessing"
              data-id="{{item.id}}"
            >
              继续处理
            </t-button>
            
          </view>
        </view>
      </t-swipe-cell>
    </view>
    
    <!-- 空状态 -->
    <t-empty 
      wx:else
      icon="inbox"
      description="{{emptyText}}"
    >
      <t-button 
        slot="action" 
        theme="primary"
        bind:click="onRefresh"
      >
        刷新列表
      </t-button>
    </t-empty>
    
    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{hasMore && ticketList.length > 0}}">
      <t-loading theme="dots" loading="{{loadingMore}}" text="加载中..." />
    </view>
  </scroll-view>

  <!-- 高级筛选弹窗 -->
  <t-popup 
    visible="{{filterPopupVisible}}" 
    placement="bottom"
    bind:visible-change="handleFilterPopupChange"
  >
    <view class="filter-popup">
      <view class="popup-header">
        <text class="popup-title">更多选项</text>
        <view class="popup-actions">
          <text class="reset-btn" bindtap="resetFilters">重置</text>
          <t-button theme="primary" size="small" bind:click="applyFilters">
            确定
          </t-button>
        </view>
      </view>
      
      <view class="filter-section" wx:if="{{assigneeOptions.length > 0}}">
        <text class="filter-label">负责人</text>
        <t-radio-group 
          value="{{tempFilters.assignee}}"
          bind:change="onAssigneeFilterChange"
        >
          <t-radio 
            wx:for="{{assigneeOptions}}" 
            wx:key="value"
            label="{{item.label}}"
            value="{{item.value}}"
          />
        </t-radio-group>
      </view>
      
      <view class="filter-section">
        <text class="filter-label">时间范围</text>
        <t-radio-group 
          value="{{tempFilters.timeRange}}"
          bind:change="onTimeRangeChange"
        >
          <t-radio 
            wx:for="{{timeRangeOptions}}" 
            wx:key="value"
            label="{{item.label}}"
            value="{{item.value}}"
          />
        </t-radio-group>
      </view>
    </view>
  </t-popup>
</view>