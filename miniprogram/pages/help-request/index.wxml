<!-- 求助请求页面 -->
<view class="help-container">
  <!-- 自定义导航栏 -->
  <t-navbar 
    title="求助中心"
    left-arrow
    bind:go-back="onBack"
  />

  <!-- 紧急求助按钮 -->
  <view class="emergency-section" wx:if="{{!isManager}}">
    <view class="emergency-card gradient-red">
      <view class="emergency-content">
        <t-icon name="notification" size="48rpx" color="white" />
        <view class="emergency-info">
          <text class="emergency-title">紧急求助</text>
          <text class="emergency-desc">遇到无法解决的问题？立即请求支援</text>
        </view>
      </view>
      <t-button 
        theme="light"
        size="large"
        bind:click="createEmergencyHelp"
      >
        发起紧急求助
      </t-button>
    </view>
  </view>

  <!-- 统计数据 -->
  <view class="stats-section">
    <view class="stats-grid">
      <view class="stat-card">
        <text class="stat-value">{{stats.pending}}</text>
        <text class="stat-label">待响应</text>
      </view>
      <view class="stat-card">
        <text class="stat-value">{{stats.processing}}</text>
        <text class="stat-label">处理中</text>
      </view>
      <view class="stat-card">
        <text class="stat-value">{{stats.todayResolved}}</text>
        <text class="stat-label">今日解决</text>
      </view>
      <view class="stat-card">
        <text class="stat-value">{{stats.avgResponseTime}}</text>
        <text class="stat-label">平均响应(分)</text>
      </view>
    </view>
  </view>

  <!-- Tab切换 -->
  <t-tabs 
    value="{{activeTab}}" 
    bind:change="onTabChange"
    sticky
  >
    <!-- 我的求助 -->
    <t-tab-panel label="我的求助" value="my" wx:if="{{!isManager}}">
      <view class="help-list">
        <view 
          class="help-card {{item.status === 'urgent' ? 'urgent' : ''}}"
          wx:for="{{myHelpList}}"
          wx:key="id"
        >
          <view class="card-header">
            <view class="help-info">
              <text class="help-no">{{item.helpNo}}</text>
              <t-tag 
                theme="{{item.statusTheme}}"
                size="small"
              >
                {{item.statusText}}
              </t-tag>
            </view>
            <text class="help-time">{{item.createTime}}</text>
          </view>
          
          <view class="card-content">
            <view class="ticket-info">
              <text class="info-label">关联工单：</text>
              <text class="ticket-no">{{item.ticketNo}}</text>
            </view>
            <view class="problem-desc">
              <text class="desc-title">问题描述：</text>
              <text class="desc-text">{{item.description}}</text>
            </view>
            <view class="attachments" wx:if="{{item.images.length > 0}}">
              <scroll-view scroll-x class="image-scroll">
                <view class="image-list">
                  <image 
                    class="attachment-image" 
                    wx:for="{{item.images}}" 
                    wx:for-item="img"
                    wx:key="index"
                    src="{{img}}"
                    mode="aspectFill"
                    data-url="{{img}}"
                    bindtap="previewImage"
                  />
                </view>
              </scroll-view>
            </view>
          </view>
          
          <view class="helper-section" wx:if="{{item.helper}}">
            <view class="helper-info">
              <image class="helper-avatar" src="{{item.helper.avatar || '/assets/default-avatar.png'}}" />
              <view class="helper-details">
                <text class="helper-name">{{item.helper.name}} 正在协助</text>
                <text class="helper-time">响应时间：{{item.responseTime}}</text>
              </view>
            </view>
            <view class="helper-actions">
              <t-button 
                theme="primary"
                size="small"
                icon="chat"
                data-id="{{item.id}}"
                bind:click="openChat"
              >
                沟通
              </t-button>
              <t-button 
                theme="default"
                size="small"
                icon="call"
                data-helper="{{item.helper}}"
                bind:click="callHelper"
              >
                电话
              </t-button>
            </view>
          </view>
          
          <view class="card-actions">
            <t-button 
              wx:if="{{item.status === 'pending'}}"
              theme="warning"
              size="small"
              data-id="{{item.id}}"
              bind:click="cancelHelp"
            >
              取消求助
            </t-button>
            <t-button 
              wx:if="{{item.status === 'processing'}}"
              theme="success"
              size="small"
              data-id="{{item.id}}"
              bind:click="confirmResolved"
            >
              已解决
            </t-button>
            <t-button 
              theme="default"
              size="small"
              data-id="{{item.id}}"
              bind:click="viewDetail"
            >
              查看详情
            </t-button>
          </view>
        </view>
        
        <t-empty 
          wx:if="{{myHelpList.length === 0}}"
          icon="info-circle"
          description="暂无求助记录"
        >
          <t-button 
            slot="action"
            theme="primary"
            size="small"
            bind:click="createHelp"
          >
            发起求助
          </t-button>
        </t-empty>
      </view>
    </t-tab-panel>

    <!-- 待响应 -->
    <t-tab-panel label="待响应 ({{pendingList.length}})" value="pending">
      <view class="help-list">
        <view 
          class="help-card {{item.priority === 'urgent' ? 'urgent' : ''}}"
          wx:for="{{pendingList}}"
          wx:key="id"
        >
          <view class="card-header">
            <view class="requester-info">
              <image class="requester-avatar" src="{{item.requester.avatar || '/assets/default-avatar.png'}}" />
              <view class="requester-details">
                <text class="requester-name">{{item.requester.name}}</text>
                <text class="requester-dept">{{item.requester.department}}</text>
              </view>
            </view>
            <view class="help-meta">
              <t-tag theme="danger" size="small" wx:if="{{item.priority === 'urgent'}}">紧急</t-tag>
              <text class="wait-time">{{item.waitTime}}</text>
            </view>
          </view>
          
          <view class="card-content">
            <view class="problem-brief">
              <text class="brief-label">问题类型：</text>
              <text class="brief-text">{{item.problemType}}</text>
            </view>
            <view class="problem-desc">
              <text class="desc-text">{{item.description}}</text>
            </view>
            <view class="location-info" wx:if="{{item.location}}">
              <t-icon name="location" size="28rpx" color="#6b7280" />
              <text class="location-text">{{item.location}}</text>
              <text class="distance-text" wx:if="{{item.distance}}">距离 {{item.distance}}km</text>
            </view>
          </view>
          
          <view class="skill-tags" wx:if="{{item.requiredSkills}}">
            <text class="tags-label">需要技能：</text>
            <view class="tags-list">
              <t-tag 
                wx:for="{{item.requiredSkills}}" 
                wx:for-item="skill"
                wx:key="index"
                theme="default"
                variant="outline"
                size="small"
              >
                {{skill}}
              </t-tag>
            </view>
          </view>
          
          <view class="card-actions">
            <t-button 
              theme="primary"
              size="small"
              icon="user-add"
              data-id="{{item.id}}"
              bind:click="acceptHelp"
            >
              接受协助
            </t-button>
            <t-button 
              theme="default"
              size="small"
              data-id="{{item.id}}"
              bind:click="viewDetail"
            >
              查看详情
            </t-button>
            <t-button 
              theme="default"
              size="small"
              icon="forward"
              data-id="{{item.id}}"
              bind:click="transferHelp"
            >
              转发
            </t-button>
          </view>
        </view>
        
        <t-empty 
          wx:if="{{pendingList.length === 0}}"
          icon="check-circle"
          description="暂无待响应的求助"
        />
      </view>
    </t-tab-panel>

    <!-- 处理中 -->
    <t-tab-panel label="处理中 ({{processingList.length}})" value="processing">
      <view class="help-list">
        <view 
          class="help-card processing"
          wx:for="{{processingList}}"
          wx:key="id"
        >
          <view class="card-header">
            <view class="process-info">
              <text class="help-no">{{item.helpNo}}</text>
              <t-tag theme="primary" variant="light" size="small">处理中</t-tag>
            </view>
            <text class="process-time">已处理 {{item.processTime}}</text>
          </view>
          
          <view class="participants">
            <view class="participant-item">
              <image class="participant-avatar" src="{{item.requester.avatar || '/assets/default-avatar.png'}}" />
              <view class="participant-info">
                <text class="participant-role">求助方</text>
                <text class="participant-name">{{item.requester.name}}</text>
              </view>
            </view>
            <t-icon name="swap" size="32rpx" color="#9ca3af" />
            <view class="participant-item">
              <image class="participant-avatar" src="{{item.helper.avatar || '/assets/default-avatar.png'}}" />
              <view class="participant-info">
                <text class="participant-role">协助方</text>
                <text class="participant-name">{{item.helper.name}}</text>
              </view>
            </view>
          </view>
          
          <view class="progress-section">
            <view class="progress-header">
              <text class="progress-label">处理进度</text>
              <text class="progress-percent">{{item.progress}}%</text>
            </view>
            <t-progress percentage="{{item.progress}}" />
            <text class="progress-desc">{{item.progressDesc}}</text>
          </view>
          
          <view class="communication-summary" wx:if="{{item.lastMessage}}">
            <view class="summary-header">
              <t-icon name="chat" size="32rpx" color="#6b7280" />
              <text class="summary-title">最新沟通</text>
            </view>
            <view class="message-preview">
              <text class="message-sender">{{item.lastMessage.sender}}：</text>
              <text class="message-text">{{item.lastMessage.text}}</text>
            </view>
          </view>
          
          <view class="card-actions">
            <t-button 
              wx:if="{{item.isHelper}}"
              theme="success"
              size="small"
              data-id="{{item.id}}"
              bind:click="markResolved"
            >
              标记已解决
            </t-button>
            <t-button 
              theme="primary"
              size="small"
              icon="chat"
              data-id="{{item.id}}"
              bind:click="openChat"
            >
              查看对话
            </t-button>
            <t-button 
              theme="default"
              size="small"
              data-id="{{item.id}}"
              bind:click="viewProgress"
            >
              进度详情
            </t-button>
          </view>
        </view>
        
        <t-empty 
          wx:if="{{processingList.length === 0}}"
          icon="time"
          description="暂无处理中的求助"
        />
      </view>
    </t-tab-panel>

    <!-- 已完成 -->
    <t-tab-panel label="已完成" value="completed">
      <view class="help-list">
        <view 
          class="help-card completed"
          wx:for="{{completedList}}"
          wx:key="id"
        >
          <view class="card-header">
            <text class="help-no">{{item.helpNo}}</text>
            <t-tag theme="success" variant="light" size="small">已完成</t-tag>
          </view>
          
          <view class="card-content">
            <view class="completion-info">
              <view class="info-row">
                <text class="info-label">求助方：</text>
                <text class="info-value">{{item.requester.name}}</text>
              </view>
              <view class="info-row">
                <text class="info-label">协助方：</text>
                <text class="info-value">{{item.helper.name}}</text>
              </view>
              <view class="info-row">
                <text class="info-label">解决时间：</text>
                <text class="info-value">{{item.resolveTime}}</text>
              </view>
              <view class="info-row">
                <text class="info-label">用时：</text>
                <text class="info-value">{{item.duration}}</text>
              </view>
            </view>
            
            <view class="solution-summary" wx:if="{{item.solution}}">
              <text class="summary-label">解决方案：</text>
              <text class="summary-text">{{item.solution}}</text>
            </view>
            
            <view class="rating-section" wx:if="{{item.rating}}">
              <text class="rating-label">评价：</text>
              <t-rate 
                value="{{item.rating}}" 
                disabled
                size="20"
              />
              <text class="rating-comment" wx:if="{{item.comment}}">{{item.comment}}</text>
            </view>
          </view>
          
          <view class="card-actions">
            <t-button 
              wx:if="{{!item.rating && item.requester.id === currentUserId}}"
              theme="primary"
              size="small"
              data-id="{{item.id}}"
              bind:click="rateHelp"
            >
              评价
            </t-button>
            <t-button 
              theme="default"
              size="small"
              data-id="{{item.id}}"
              bind:click="viewDetail"
            >
              查看详情
            </t-button>
            <t-button 
              theme="default"
              size="small"
              icon="file-copy"
              data-id="{{item.id}}"
              bind:click="saveToKnowledge"
              wx:if="{{item.canSaveToKnowledge}}"
            >
              存为案例
            </t-button>
          </view>
        </view>
        
        <t-empty 
          wx:if="{{completedList.length === 0}}"
          icon="folder"
          description="暂无已完成的求助"
        />
      </view>
    </t-tab-panel>
  </t-tabs>

  <!-- 发起求助弹窗 -->
  <t-popup 
    visible="{{createHelpVisible}}" 
    placement="bottom"
    bind:visible-change="handleCreateHelpChange"
  >
    <view class="create-help-dialog">
      <view class="dialog-header">
        <text class="dialog-title">发起求助</text>
        <t-icon name="close" size="48rpx" bindtap="closeCreateHelp" />
      </view>
      
      <scroll-view scroll-y class="dialog-content">
        <view class="form-group">
          <text class="form-label required">问题类型</text>
          <t-radio-group 
            value="{{helpForm.type}}"
            bind:change="onHelpTypeChange"
          >
            <t-radio value="hardware" label="硬件故障" />
            <t-radio value="software" label="软件问题" />
            <t-radio value="network" label="网络故障" />
            <t-radio value="technical" label="技术难题" />
            <t-radio value="other" label="其他" />
          </t-radio-group>
        </view>
        
        <view class="form-group">
          <text class="form-label">优先级</text>
          <t-radio-group 
            value="{{helpForm.priority}}"
            bind:change="onPriorityChange"
          >
            <t-radio value="normal" label="普通" />
            <t-radio value="urgent" label="紧急" />
          </t-radio-group>
        </view>
        
        <view class="form-group">
          <text class="form-label">关联工单</text>
          <t-input 
            value="{{helpForm.ticketNo}}"
            placeholder="输入工单号（可选）"
            bind:change="onTicketNoChange"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label required">问题描述</text>
          <t-textarea
            value="{{helpForm.description}}"
            placeholder="详细描述您遇到的问题..."
            maxlength="500"
            bind:change="onDescriptionChange"
          />
        </view>
        
        <view class="form-group">
          <text class="form-label">上传图片</text>
          <view class="image-uploader">
            <view class="uploaded-images">
              <view 
                class="uploaded-item" 
                wx:for="{{helpForm.images}}" 
                wx:key="index"
              >
                <image src="{{item}}" mode="aspectFill" />
                <t-icon 
                  name="close-circle" 
                  size="36rpx" 
                  color="#ef4444"
                  data-index="{{index}}"
                  bindtap="removeImage"
                />
              </view>
              <view 
                class="upload-btn" 
                bindtap="chooseImage"
                wx:if="{{helpForm.images.length < 4}}"
              >
                <t-icon name="add" size="48rpx" color="#9ca3af" />
                <text>添加图片</text>
              </view>
            </view>
          </view>
        </view>
        
        <view class="form-group">
          <text class="form-label">需要的技能</text>
          <view class="skill-selector">
            <t-tag 
              wx:for="{{availableSkills}}" 
              wx:key="index"
              theme="{{helpForm.requiredSkills.indexOf(item) !== -1 ? 'primary' : 'default'}}"
              variant="{{helpForm.requiredSkills.indexOf(item) !== -1 ? 'dark' : 'outline'}}"
              size="medium"
              data-skill="{{item}}"
              bindtap="toggleSkill"
            >
              {{item}}
            </t-tag>
          </view>
        </view>
      </scroll-view>
      
      <view class="dialog-actions">
        <t-button theme="default" bind:click="closeCreateHelp">取消</t-button>
        <t-button theme="primary" bind:click="submitHelp">提交求助</t-button>
      </view>
    </view>
  </t-popup>

  <!-- 评价弹窗 -->
  <t-popup 
    visible="{{rateDialogVisible}}" 
    placement="center"
    bind:visible-change="handleRateDialogChange"
  >
    <view class="rate-dialog">
      <view class="dialog-header">
        <text class="dialog-title">评价协助</text>
      </view>
      
      <view class="dialog-content">
        <view class="rate-section">
          <text class="rate-label">服务评分</text>
          <t-rate 
            value="{{rateForm.score}}"
            bind:change="onRateChange"
            size="32"
          />
        </view>
        
        <view class="comment-section">
          <text class="comment-label">评价内容</text>
          <t-textarea
            value="{{rateForm.comment}}"
            placeholder="请输入您的评价..."
            maxlength="200"
            bind:change="onCommentChange"
          />
        </view>
      </view>
      
      <view class="dialog-actions">
        <t-button theme="default" size="small" bind:click="closeRateDialog">取消</t-button>
        <t-button theme="primary" size="small" bind:click="submitRate">提交评价</t-button>
      </view>
    </view>
  </t-popup>

  <!-- 悬浮按钮 -->
  <t-fab 
    wx:if="{{!isManager}}"
    icon="add"
    bind:click="createHelp"
    style="bottom: 120rpx; right: 32rpx;"
  />
</view>