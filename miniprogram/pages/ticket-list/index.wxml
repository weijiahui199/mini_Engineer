<!-- å·¥å•åˆ—è¡¨é¡µé¢ -->
<view class="ticket-list-container">
  <!-- æœç´¢æ  -->
  <view class="search-container">
    <t-search
      model:value="{{searchKeyword}}"
      placeholder="æœç´¢å·¥å•å·ã€æ ‡é¢˜ã€æäº¤äºº..."
      bind:change="onSearchChange"
      bind:submit="onSearch"
    />
  </view>

  <!-- ç­›é€‰æ  -->
  <view class="filter-container">
    <!-- è´Ÿè´£äººæ˜¾ç¤º -->
    <view class="assignee-display" wx:if="{{userRoleGroup === 'ç»ç†' || currentAssignee === 'my'}}">
      <text class="assignee-label">è´Ÿè´£äººï¼š</text>
      <text class="assignee-value">
        <block wx:if="{{currentAssignee === 'all'}}">å…¨éƒ¨</block>
        <block wx:elif="{{currentAssignee === 'my'}}">æˆ‘è´Ÿè´£çš„</block>
        <block wx:else>
          <block wx:for="{{assigneeOptions}}" wx:key="value">
            <text wx:if="{{item.value === currentAssignee}}">{{item.label}}</text>
          </block>
        </block>
      </text>
    </view>
    
    <scroll-view scroll-x class="filter-scroll">
      <view class="filter-tabs">
        <t-tag 
          wx:for="{{filterOptions}}" 
          wx:key="value"
          theme="{{item.value === currentFilter ? 'primary' : 'default'}}"
          variant="{{item.value === currentFilter ? 'dark' : 'outline'}}"
          bind:click="onFilterClick"
          data-value="{{item.value}}"
        >
          {{item.label}}
          <text wx:if="{{item.count > 0}}" class="filter-count">({{item.count}})</text>
        </t-tag>
        
        <t-tag 
          theme="default"
          variant="outline"
          bind:click="showMoreFilters"
        >
          <text class="filter-icon">âš™ï¸</text>
          æ›´å¤š
        </t-tag>
      </view>
    </scroll-view>
  </view>

  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-bar" wx:if="{{showStats}}">
    <view class="stats-content">
      <text class="stats-text">ä»Šæ—¥å·¥å•: {{todayStats.assigned}}ä¸ª</text>
      <text class="stats-highlight">å®Œæˆç‡: {{todayStats.completionRate}}%</text>
    </view>
  </view>

  <!-- å·¥å•åˆ—è¡¨ -->
  <scroll-view 
    scroll-y="{{true}}"
    class="ticket-scroll"
    bindscrolltolower="onLoadMore"
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    enhanced="{{true}}"
    bounces="{{true}}"
    show-scrollbar="{{false}}"
  >
    <view class="ticket-list" wx:if="{{ticketList.length > 0}}">
      <t-swipe-cell 
        wx:for="{{ticketList}}" 
        wx:key="id"
        right="{{getSwipeActions(item)}}"
      >
        <view 
          class="ticket-card {{item.priority === 'urgent' ? 'urgent-border' : ''}} {{!item.assigneeOpenid && item.status === 'pending' ? 'pool-ticket' : ''}} {{item.assigneeOpenid && item.assigneeOpenid !== openid ? 'taken' : ''}} {{item.assigneeOpenid === openid ? 'my-ticket' : ''}}"
        >
          <!-- å¯ç‚¹å‡»åŒºåŸŸ - ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… -->
          <view class="card-clickable" bindtap="navigateToDetail" data-id="{{item.id}}">
            <!-- å·¥å•å¤´éƒ¨ -->
            <view class="card-header">
            <view class="header-left">
              <view class="priority-dot priority-{{item.priority}}"></view>
              <text class="ticket-no">{{item.ticketNo}}</text>
              <t-tag 
                wx:if="{{item.priority === 'urgent'}}"
                theme="danger"
                variant="light"
                size="small"
              >
                ç´§æ€¥
              </t-tag>
              <t-tag 
                wx:elif="{{item.priority === 'high'}}"
                theme="warning"
                variant="light"
                size="small"
              >
                é«˜
              </t-tag>
            </view>
            <view class="header-right">
              <t-tag 
                theme="{{item.status === 'paused' ? 'warning' : getStatusTheme(item.status)}}"
                variant="light"
                size="small"
              >
                {{statusText[item.status]}}
              </t-tag>
            </view>
          </view>
          
          <!-- å·¥å•å†…å®¹ -->
          <view class="card-content">
            <text class="ticket-title">{{item.title}}</text>
            <text class="ticket-category">{{item.category}}</text>
          </view>
          
          <!-- å·¥å•ä¿¡æ¯ -->
          <view class="card-info">
            <view class="info-item">
              <text class="info-icon">ğŸ‘¤</text>
              <text class="info-text">{{item.submitter}}</text>
            </view>
            <view class="info-item">
              <text class="info-icon">ğŸ“</text>
              <text class="info-text">{{item.location}}</text>
            </view>
            <view class="info-item">
              <text class="info-icon">â°</text>
              <text class="info-text">{{item.displayTime}}</text>
            </view>
            <view class="info-item" wx:if="{{item.assigneeName && userRoleGroup === 'ç»ç†' && currentAssignee === 'all'}}">
              <text class="info-icon">ğŸ‘·</text>
              <text class="info-text">{{item.assigneeName}}</text>
            </view>
          </view>
          </view>
          <!-- ç»“æŸå¯ç‚¹å‡»åŒºåŸŸ -->
          
          <!-- æ“ä½œæŒ‰é’® - ç‹¬ç«‹äºå¯ç‚¹å‡»åŒºåŸŸ -->
          <view class="card-actions">
            
            <!-- åœºæ™¯1ï¼šæœªåˆ†é…å·¥å• - æ˜¾ç¤ºå¼€å§‹å¤„ç†æŒ‰é’® -->
            <button 
              wx:if="{{userRoleGroup === 'å·¥ç¨‹å¸ˆ' && item.realStatus === 'pending' && !item.assigneeOpenid}}"
              class="custom-btn btn-primary"
              catchtap="acceptTicketSafely"
              data-id="{{item.id}}"
            >
              å¼€å§‹å¤„ç†
            </button>
            
            <!-- åœºæ™¯2ï¼šæš‚åœçŠ¶æ€çš„å·¥å• - æ˜¾ç¤ºç»§ç»­å¤„ç†æŒ‰é’® -->
            <button 
              wx:elif="{{item.status === 'paused' && item.assigneeOpenid === openid}}"
              class="custom-btn btn-continue"
              catchtap="continueProcessing"
              data-id="{{item.id}}"
            >
              ç»§ç»­å¤„ç†
            </button>
            
            <!-- åœºæ™¯3ï¼šæˆ‘çš„å·¥å•(processingçŠ¶æ€) - æ˜¾ç¤ºæŸ¥çœ‹è¯¦æƒ…å’Œå®Œæˆå·¥å•ä¸¤ä¸ªæŒ‰é’® -->
            <block wx:elif="{{item.assigneeOpenid === openid && item.status === 'processing'}}">
              <button 
                class="custom-btn btn-detail"
                catchtap="navigateToDetail"
                data-id="{{item.id}}"
              >
                æŸ¥çœ‹è¯¦æƒ…
              </button>
              <button 
                class="custom-btn btn-complete"
                catchtap="completeTicket"
                data-id="{{item.id}}"
              >
                å®Œæˆå·¥å•
              </button>
            </block>
            
            <!-- åœºæ™¯3ï¼šæˆ‘çš„å·¥å•(å·²è§£å†³) - æ˜¾ç¤ºæŸ¥çœ‹è¯¦æƒ… -->
            <button 
              wx:elif="{{item.assigneeOpenid === openid && item.status === 'resolved'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              æŸ¥çœ‹è¯¦æƒ…
            </button>
            
            <!-- åœºæ™¯3.5ï¼šå·²å…³é—­å·¥å• - æ˜¾ç¤ºå·²å…³é—­æ ‡ç­¾ -->
            <t-tag
              wx:elif="{{item.status === 'closed'}}"
              theme="default"
              variant="outline"
              size="medium"
            >
              å·²å…³é—­
            </t-tag>
            
            <!-- åœºæ™¯4ï¼šä»–äººçš„å·¥å• - æ˜¾ç¤ºå·²è¢«æ¥å•æ–‡å­— -->
            <text 
              wx:elif="{{userRoleGroup === 'å·¥ç¨‹å¸ˆ' && item.assigneeOpenid && item.assigneeOpenid !== openid}}"
              class="status-hint"
            >
              å·²è¢«æ¥å•
            </text>
            
            <!-- åœºæ™¯5ï¼šç»ç†è§’è‰² - å§‹ç»ˆæ˜¾ç¤ºæŸ¥çœ‹è¯¦æƒ… -->
            <button 
              wx:elif="{{userRoleGroup === 'ç»ç†'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              æŸ¥çœ‹è¯¦æƒ…
            </button>
            
            <!-- åœºæ™¯6ï¼šæ™®é€šç”¨æˆ·æŸ¥çœ‹è‡ªå·±æäº¤çš„å·¥å• -->
            <button 
              wx:elif="{{userRoleGroup === 'ç”¨æˆ·'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              æŸ¥çœ‹è¯¦æƒ…
            </button>
          </view>
        </view>
      </t-swipe-cell>
    </view>
    
    <!-- ç©ºçŠ¶æ€ -->
    <t-empty 
      wx:else
      icon="inbox"
      description="{{emptyText}}"
    >
      <t-button 
        slot="action" 
        theme="primary"
        bind:click="onRefresh"
      >
        åˆ·æ–°åˆ—è¡¨
      </t-button>
    </t-empty>
    
    <!-- åŠ è½½æ›´å¤š -->
    <view class="load-more" wx:if="{{hasMore && ticketList.length > 0}}">
      <t-loading theme="dots" loading="{{loadingMore}}" text="åŠ è½½ä¸­..." />
    </view>
  </scroll-view>

  <!-- é«˜çº§ç­›é€‰å¼¹çª— -->
  <t-popup 
    visible="{{filterPopupVisible}}" 
    placement="bottom"
    bind:visible-change="handleFilterPopupChange"
  >
    <view class="filter-popup">
      <view class="popup-header">
        <text class="popup-title">æ›´å¤šé€‰é¡¹</text>
        <view class="popup-actions">
          <text class="reset-btn" bindtap="resetFilters">é‡ç½®</text>
          <t-button theme="primary" size="small" bind:click="applyFilters">
            ç¡®å®š
          </t-button>
        </view>
      </view>
      
      <view class="filter-section" wx:if="{{showAssigneeFilter && assigneeOptions.length > 0}}">
        <text class="filter-label">è´Ÿè´£äºº</text>
        <t-radio-group 
          value="{{tempFilters.assignee}}"
          bind:change="onAssigneeFilterChange"
        >
          <t-radio label="å…¨éƒ¨" value="all" />
          <t-radio label="æˆ‘è´Ÿè´£çš„" value="my" />
          <t-radio 
            wx:for="{{assigneeOptions}}" 
            wx:key="value"
            wx:if="{{item.value !== 'all' && item.value !== 'my'}}"
            label="{{item.label}}"
            value="{{item.value}}"
          />
        </t-radio-group>
      </view>
      
      <view class="filter-section">
        <text class="filter-label">æ—¶é—´èŒƒå›´</text>
        <t-radio-group 
          value="{{tempFilters.timeRange}}"
          bind:change="onTimeRangeChange"
        >
          <t-radio 
            wx:for="{{timeRangeOptions}}" 
            wx:key="value"
            label="{{item.label}}"
            value="{{item.value}}"
          />
        </t-radio-group>
      </view>
      
      <!-- é—®é¢˜ç±»å‹ç­›é€‰ -->
      <view class="filter-section">
        <text class="filter-label">é—®é¢˜ç±»å‹</text>
        <t-radio-group 
          value="{{tempFilters.category}}"
          bind:change="onCategoryChange"
        >
          <t-radio label="å…¨éƒ¨" value="all" />
          <t-radio label="ç¡¬ä»¶æ•…éšœ" value="hardware" />
          <t-radio label="è½¯ä»¶é—®é¢˜" value="software" />
          <t-radio label="ç½‘ç»œé—®é¢˜" value="network" />
          <t-radio label="è´¦å·æƒé™" value="account" />
          <t-radio label="å…¶ä»–" value="other" />
        </t-radio-group>
      </view>
      
      <!-- ä¼˜å…ˆçº§ç­›é€‰ -->
      <view class="filter-section">
        <text class="filter-label">ä¼˜å…ˆçº§</text>
        <t-checkbox-group 
          value="{{tempFilters.priority}}"
          bind:change="onPriorityChange"
        >
          <t-checkbox label="ç´§æ€¥" value="urgent" />
          <t-checkbox label="é«˜" value="high" />
          <t-checkbox label="ä¸­" value="medium" />
          <t-checkbox label="ä½" value="low" />
        </t-checkbox-group>
      </view>
    </view>
  </t-popup>
</view>