<!-- 工单列表页面 -->
<view class="ticket-list-container">
  <!-- 搜索栏 -->
  <view class="search-container">
    <t-search
      model:value="{{searchKeyword}}"
      placeholder="搜索工单号、标题、提交人..."
      bind:change="onSearchChange"
      bind:submit="onSearch"
    />
  </view>

  <!-- 筛选栏 -->
  <view class="filter-container">
    <!-- 负责人显示 -->
    <view class="assignee-display" wx:if="{{userRoleGroup === '经理' || currentAssignee === 'my'}}">
      <text class="assignee-label">负责人：</text>
      <text class="assignee-value">
        <block wx:if="{{currentAssignee === 'all'}}">全部</block>
        <block wx:elif="{{currentAssignee === 'my'}}">我负责的</block>
        <block wx:else>
          <block wx:for="{{assigneeOptions}}" wx:key="value">
            <text wx:if="{{item.value === currentAssignee}}">{{item.label}}</text>
          </block>
        </block>
      </text>
    </view>
    
    <scroll-view scroll-x class="filter-scroll">
      <view class="filter-tabs">
        <t-tag 
          wx:for="{{filterOptions}}" 
          wx:key="value"
          theme="{{item.value === currentFilter ? 'primary' : 'default'}}"
          variant="{{item.value === currentFilter ? 'dark' : 'outline'}}"
          bind:click="onFilterClick"
          data-value="{{item.value}}"
        >
          {{item.label}}
          <text wx:if="{{item.count > 0}}" class="filter-count">({{item.count}})</text>
        </t-tag>
        
        <t-tag 
          theme="default"
          variant="outline"
          bind:click="showMoreFilters"
        >
          <text class="filter-icon">⚙️</text>
          更多
        </t-tag>
      </view>
    </scroll-view>
  </view>

  <!-- 统计信息 -->
  <view class="stats-bar" wx:if="{{showStats}}">
    <view class="stats-content">
      <text class="stats-text">今日工单: {{todayStats.assigned}}个</text>
      <text class="stats-highlight">完成率: {{todayStats.completionRate}}%</text>
    </view>
  </view>

  <!-- 工单列表 -->
  <scroll-view 
    scroll-y="{{true}}"
    class="ticket-scroll"
    bindscrolltolower="onLoadMore"
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    enhanced="{{true}}"
    bounces="{{true}}"
    show-scrollbar="{{false}}"
  >
    <view class="ticket-list" wx:if="{{ticketList.length > 0}}">
      <t-swipe-cell 
        wx:for="{{ticketList}}" 
        wx:key="id"
        right="{{getSwipeActions(item)}}"
      >
        <view 
          class="ticket-card {{item.priority === 'urgent' ? 'urgent-border' : ''}} {{!item.assigneeOpenid && item.status === 'pending' ? 'pool-ticket' : ''}} {{item.assigneeOpenid && item.assigneeOpenid !== openid ? 'taken' : ''}} {{item.assigneeOpenid === openid ? 'my-ticket' : ''}}"
        >
          <!-- 可点击区域 - 点击查看详情 -->
          <view class="card-clickable" bindtap="navigateToDetail" data-id="{{item.id}}">
            <!-- 工单头部 -->
            <view class="card-header">
            <view class="header-left">
              <view class="priority-dot priority-{{item.priority}}"></view>
              <text class="ticket-no">{{item.ticketNo}}</text>
              <t-tag 
                wx:if="{{item.priority === 'urgent'}}"
                theme="danger"
                variant="light"
                size="small"
              >
                紧急
              </t-tag>
              <t-tag 
                wx:elif="{{item.priority === 'high'}}"
                theme="warning"
                variant="light"
                size="small"
              >
                高
              </t-tag>
            </view>
            <view class="header-right">
              <t-tag 
                theme="{{item.status === 'paused' ? 'warning' : getStatusTheme(item.status)}}"
                variant="light"
                size="small"
              >
                {{statusText[item.status]}}
              </t-tag>
            </view>
          </view>
          
          <!-- 工单内容 -->
          <view class="card-content">
            <text class="ticket-title">{{item.title}}</text>
            <text class="ticket-category">{{item.category}}</text>
          </view>
          
          <!-- 工单信息 -->
          <view class="card-info">
            <view class="info-item">
              <text class="info-icon">👤</text>
              <text class="info-text">{{item.submitter}}</text>
            </view>
            <view class="info-item">
              <text class="info-icon">📍</text>
              <text class="info-text">{{item.location}}</text>
            </view>
            <view class="info-item">
              <text class="info-icon">⏰</text>
              <text class="info-text">{{item.displayTime}}</text>
            </view>
            <view class="info-item" wx:if="{{item.assigneeName && userRoleGroup === '经理' && currentAssignee === 'all'}}">
              <text class="info-icon">👷</text>
              <text class="info-text">{{item.assigneeName}}</text>
            </view>
          </view>
          </view>
          <!-- 结束可点击区域 -->
          
          <!-- 操作按钮 - 独立于可点击区域 -->
          <view class="card-actions">
            
            <!-- 场景1：未分配工单 - 显示开始处理按钮 -->
            <button 
              wx:if="{{userRoleGroup === '工程师' && item.realStatus === 'pending' && !item.assigneeOpenid}}"
              class="custom-btn btn-primary"
              catchtap="acceptTicketSafely"
              data-id="{{item.id}}"
            >
              开始处理
            </button>
            
            <!-- 场景2：暂停状态的工单 - 显示继续处理按钮 -->
            <button 
              wx:elif="{{item.status === 'paused' && item.assigneeOpenid === openid}}"
              class="custom-btn btn-continue"
              catchtap="continueProcessing"
              data-id="{{item.id}}"
            >
              继续处理
            </button>
            
            <!-- 场景3：我的工单(processing状态) - 显示查看详情和完成工单两个按钮 -->
            <block wx:elif="{{item.assigneeOpenid === openid && item.status === 'processing'}}">
              <button 
                class="custom-btn btn-detail"
                catchtap="navigateToDetail"
                data-id="{{item.id}}"
              >
                查看详情
              </button>
              <button 
                class="custom-btn btn-complete"
                catchtap="completeTicket"
                data-id="{{item.id}}"
              >
                完成工单
              </button>
            </block>
            
            <!-- 场景3：我的工单(已解决) - 显示查看详情 -->
            <button 
              wx:elif="{{item.assigneeOpenid === openid && item.status === 'resolved'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              查看详情
            </button>
            
            <!-- 场景3.5：已关闭工单 - 显示已关闭标签 -->
            <t-tag
              wx:elif="{{item.status === 'closed'}}"
              theme="default"
              variant="outline"
              size="medium"
            >
              已关闭
            </t-tag>
            
            <!-- 场景4：他人的工单 - 显示已被接单文字 -->
            <text 
              wx:elif="{{userRoleGroup === '工程师' && item.assigneeOpenid && item.assigneeOpenid !== openid}}"
              class="status-hint"
            >
              已被接单
            </text>
            
            <!-- 场景5：经理角色 - 始终显示查看详情 -->
            <button 
              wx:elif="{{userRoleGroup === '经理'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              查看详情
            </button>
            
            <!-- 场景6：普通用户查看自己提交的工单 -->
            <button 
              wx:elif="{{userRoleGroup === '用户'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              查看详情
            </button>
          </view>
        </view>
      </t-swipe-cell>
    </view>
    
    <!-- 空状态 -->
    <t-empty 
      wx:else
      icon="inbox"
      description="{{emptyText}}"
    >
      <t-button 
        slot="action" 
        theme="primary"
        bind:click="onRefresh"
      >
        刷新列表
      </t-button>
    </t-empty>
    
    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{hasMore && ticketList.length > 0}}">
      <t-loading theme="dots" loading="{{loadingMore}}" text="加载中..." />
    </view>
  </scroll-view>

  <!-- 高级筛选弹窗 -->
  <t-popup 
    visible="{{filterPopupVisible}}" 
    placement="bottom"
    bind:visible-change="handleFilterPopupChange"
  >
    <view class="filter-popup">
      <view class="popup-header">
        <text class="popup-title">更多选项</text>
        <view class="popup-actions">
          <text class="reset-btn" bindtap="resetFilters">重置</text>
          <t-button theme="primary" size="small" bind:click="applyFilters">
            确定
          </t-button>
        </view>
      </view>
      
      <view class="filter-section" wx:if="{{showAssigneeFilter && assigneeOptions.length > 0}}">
        <text class="filter-label">负责人</text>
        <t-radio-group 
          value="{{tempFilters.assignee}}"
          bind:change="onAssigneeFilterChange"
        >
          <t-radio label="全部" value="all" />
          <t-radio label="我负责的" value="my" />
          <t-radio 
            wx:for="{{assigneeOptions}}" 
            wx:key="value"
            wx:if="{{item.value !== 'all' && item.value !== 'my'}}"
            label="{{item.label}}"
            value="{{item.value}}"
          />
        </t-radio-group>
      </view>
      
      <view class="filter-section">
        <text class="filter-label">时间范围</text>
        <t-radio-group 
          value="{{tempFilters.timeRange}}"
          bind:change="onTimeRangeChange"
        >
          <t-radio 
            wx:for="{{timeRangeOptions}}" 
            wx:key="value"
            label="{{item.label}}"
            value="{{item.value}}"
          />
        </t-radio-group>
      </view>
      
      <!-- 问题类型筛选 -->
      <view class="filter-section">
        <text class="filter-label">问题类型</text>
        <t-radio-group 
          value="{{tempFilters.category}}"
          bind:change="onCategoryChange"
        >
          <t-radio label="全部" value="all" />
          <t-radio label="硬件故障" value="hardware" />
          <t-radio label="软件问题" value="software" />
          <t-radio label="网络问题" value="network" />
          <t-radio label="账号权限" value="account" />
          <t-radio label="其他" value="other" />
        </t-radio-group>
      </view>
      
      <!-- 优先级筛选 -->
      <view class="filter-section">
        <text class="filter-label">优先级</text>
        <t-checkbox-group 
          value="{{tempFilters.priority}}"
          bind:change="onPriorityChange"
        >
          <t-checkbox label="紧急" value="urgent" />
          <t-checkbox label="高" value="high" />
          <t-checkbox label="中" value="medium" />
          <t-checkbox label="低" value="low" />
        </t-checkbox-group>
      </view>
    </view>
  </t-popup>
</view>