<!-- 工单分配页面 -->
<view class="assign-container">
  <!-- 自定义导航栏 -->
  <t-navbar 
    title="工单分配"
    left-arrow
    bind:go-back="onBack"
  />

  <!-- 统计卡片 -->
  <view class="stats-section">
    <view class="stats-card gradient-bg">
      <view class="stats-grid">
        <view class="stat-item">
          <text class="stat-value">{{stats.unassigned}}</text>
          <text class="stat-label">待分配</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value">{{stats.todayAssigned}}</text>
          <text class="stat-label">今日已分配</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-value">{{stats.avgWaitTime}}</text>
          <text class="stat-label">平均等待(分)</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 快速操作 -->
  <view class="quick-actions">
    <t-button 
      theme="primary"
      size="medium"
      icon="control"
      bind:click="autoAssign"
    >
      智能分配
    </t-button>
    <t-button 
      theme="default"
      size="medium"
      icon="refresh"
      bind:click="refreshList"
    >
      刷新列表
    </t-button>
    <t-button 
      theme="default"
      size="medium"
      icon="filter"
      bind:click="showFilter"
    >
      筛选
    </t-button>
  </view>

  <!-- Tab切换 -->
  <t-tabs 
    value="{{activeTab}}" 
    bind:change="onTabChange"
    sticky
  >
    <t-tab-panel label="待分配 ({{unassignedList.length}})" value="unassigned">
      <!-- 待分配工单列表 -->
      <view class="ticket-list">
        <view 
          class="ticket-card {{item.priority === 'urgent' ? 'urgent' : ''}}"
          wx:for="{{unassignedList}}"
          wx:key="id"
        >
          <!-- 工单头部 -->
          <view class="card-header">
            <view class="ticket-info">
              <text class="ticket-no">{{item.ticketNo}}</text>
              <t-tag 
                theme="{{item.priority === 'urgent' ? 'danger' : item.priority === 'high' ? 'warning' : 'default'}}"
                size="small"
              >
                {{item.priorityText}}
              </t-tag>
            </view>
            <text class="create-time">{{item.createTime}}</text>
          </view>
          
          <!-- 工单内容 -->
          <view class="card-content">
            <view class="content-row">
              <t-icon name="user" size="32rpx" color="#6b7280" />
              <text class="content-text">{{item.userName}} - {{item.department}}</text>
            </view>
            <view class="content-row">
              <t-icon name="location" size="32rpx" color="#6b7280" />
              <text class="content-text">{{item.location}}</text>
            </view>
            <view class="content-row">
              <t-icon name="file-copy" size="32rpx" color="#6b7280" />
              <text class="content-text">{{item.issueType}}</text>
            </view>
            <view class="description">
              <text class="desc-label">问题描述：</text>
              <text class="desc-text">{{item.description}}</text>
            </view>
          </view>
          
          <!-- 工程师选择 -->
          <view class="engineer-section">
            <view class="section-title">分配给：</view>
            <scroll-view scroll-x class="engineer-scroll">
              <view class="engineer-list">
                <view 
                  class="engineer-item {{item.selectedEngineerId === engineer.id ? 'selected' : ''}}"
                  wx:for="{{availableEngineers}}"
                  wx:for-item="engineer"
                  wx:key="id"
                  data-ticket-id="{{item.id}}"
                  data-engineer-id="{{engineer.id}}"
                  bindtap="selectEngineer"
                >
                  <image class="engineer-avatar" src="{{engineer.avatar || '/assets/default-avatar.png'}}" />
                  <text class="engineer-name">{{engineer.name}}</text>
                  <view class="engineer-status">
                    <view class="status-dot {{engineer.statusClass}}"></view>
                    <text class="task-count">{{engineer.currentTasks}}/{{engineer.maxTasks}}</text>
                  </view>
                  <view class="engineer-tags">
                    <t-tag size="small" wx:if="{{engineer.distance}}">{{engineer.distance}}km</t-tag>
                    <t-tag size="small" theme="success" wx:if="{{engineer.matchScore >= 80}}">推荐</t-tag>
                  </view>
                </view>
              </view>
            </scroll-view>
          </view>
          
          <!-- 操作按钮 -->
          <view class="card-actions">
            <t-button 
              theme="primary"
              size="small"
              disabled="{{!item.selectedEngineerId}}"
              data-id="{{item.id}}"
              bind:click="confirmAssign"
            >
              确认分配
            </t-button>
            <t-button 
              theme="default"
              size="small"
              data-id="{{item.id}}"
              bind:click="viewDetail"
            >
              查看详情
            </t-button>
            <t-button 
              theme="default"
              size="small"
              data-id="{{item.id}}"
              bind:click="postpone"
            >
              延后处理
            </t-button>
          </view>
        </view>
        
        <t-empty 
          wx:if="{{unassignedList.length === 0}}"
          icon="inbox"
          description="暂无待分配工单"
        />
      </view>
    </t-tab-panel>

    <t-tab-panel label="分配中 ({{assigningList.length}})" value="assigning">
      <!-- 分配中工单列表 -->
      <view class="ticket-list">
        <view 
          class="ticket-card assigning"
          wx:for="{{assigningList}}"
          wx:key="id"
        >
          <view class="card-header">
            <text class="ticket-no">{{item.ticketNo}}</text>
            <t-tag theme="primary" variant="light" size="small">分配中</t-tag>
          </view>
          
          <view class="card-content">
            <view class="assign-info">
              <text class="info-label">分配给：</text>
              <view class="engineer-info">
                <image class="small-avatar" src="{{item.engineer.avatar || '/assets/default-avatar.png'}}" />
                <text class="engineer-name">{{item.engineer.name}}</text>
              </view>
            </view>
            <view class="assign-progress">
              <text class="progress-label">等待确认：</text>
              <text class="progress-time">{{item.waitTime}}</text>
            </view>
          </view>
          
          <view class="card-actions">
            <t-button 
              theme="warning"
              size="small"
              data-id="{{item.id}}"
              bind:click="cancelAssign"
            >
              取消分配
            </t-button>
            <t-button 
              theme="primary"
              size="small"
              data-id="{{item.id}}"
              bind:click="reassign"
            >
              重新分配
            </t-button>
          </view>
        </view>
        
        <t-empty 
          wx:if="{{assigningList.length === 0}}"
          icon="time"
          description="暂无分配中的工单"
        />
      </view>
    </t-tab-panel>

    <t-tab-panel label="已分配 ({{assignedList.length}})" value="assigned">
      <!-- 已分配工单列表 -->
      <view class="ticket-list">
        <view 
          class="ticket-card assigned"
          wx:for="{{assignedList}}"
          wx:key="id"
        >
          <view class="card-header">
            <text class="ticket-no">{{item.ticketNo}}</text>
            <t-tag theme="success" variant="light" size="small">已分配</t-tag>
          </view>
          
          <view class="card-content">
            <view class="assign-info">
              <text class="info-label">处理工程师：</text>
              <view class="engineer-info">
                <image class="small-avatar" src="{{item.engineer.avatar || '/assets/default-avatar.png'}}" />
                <text class="engineer-name">{{item.engineer.name}}</text>
                <t-tag size="small" theme="{{item.engineer.statusTheme}}">{{item.engineer.statusText}}</t-tag>
              </view>
            </view>
            <view class="timeline-info">
              <text class="time-item">分配时间：{{item.assignTime}}</text>
              <text class="time-item">开始处理：{{item.startTime || '未开始'}}</text>
            </view>
          </view>
          
          <view class="card-actions">
            <t-button 
              theme="default"
              size="small"
              data-id="{{item.id}}"
              bind:click="trackProgress"
            >
              跟踪进度
            </t-button>
            <t-button 
              theme="default"
              size="small"
              data-id="{{item.id}}"
              bind:click="contactEngineer"
            >
              联系工程师
            </t-button>
          </view>
        </view>
        
        <t-empty 
          wx:if="{{assignedList.length === 0}}"
          icon="check-circle"
          description="暂无已分配工单"
        />
      </view>
    </t-tab-panel>
  </t-tabs>

  <!-- 智能分配弹窗 -->
  <t-popup 
    visible="{{autoAssignVisible}}" 
    placement="bottom"
    bind:visible-change="handleAutoAssignChange"
  >
    <view class="auto-assign-dialog">
      <view class="dialog-header">
        <text class="dialog-title">智能分配设置</text>
        <t-icon name="close" size="48rpx" bindtap="closeAutoAssign" />
      </view>
      
      <view class="dialog-content">
        <view class="setting-item">
          <text class="setting-label">分配策略</text>
          <t-radio-group 
            value="{{autoAssignStrategy}}"
            bind:change="onStrategyChange"
          >
            <t-radio value="balance" label="负载均衡" />
            <t-radio value="distance" label="就近分配" />
            <t-radio value="skill" label="技能匹配" />
            <t-radio value="smart" label="智能推荐" />
          </t-radio-group>
        </view>
        
        <view class="setting-item">
          <text class="setting-label">优先级处理</text>
          <t-switch 
            value="{{priorityFirst}}"
            bind:change="onPriorityFirstChange"
          />
          <text class="setting-hint">优先处理紧急工单</text>
        </view>
        
        <view class="setting-item">
          <text class="setting-label">分配范围</text>
          <t-checkbox-group 
            value="{{assignRange}}"
            bind:change="onAssignRangeChange"
          >
            <t-checkbox value="online" label="在线工程师" />
            <t-checkbox value="available" label="空闲工程师" />
            <t-checkbox value="all" label="所有工程师" />
          </t-checkbox-group>
        </view>
        
        <view class="preview-section">
          <text class="preview-title">预计分配结果</text>
          <view class="preview-list">
            <view class="preview-item" wx:for="{{assignPreview}}" wx:key="ticketId">
              <text class="preview-ticket">{{item.ticketNo}}</text>
              <t-icon name="arrow-right" size="32rpx" color="#9ca3af" />
              <text class="preview-engineer">{{item.engineerName}}</text>
            </view>
          </view>
        </view>
      </view>
      
      <view class="dialog-actions">
        <t-button theme="default" bind:click="closeAutoAssign">取消</t-button>
        <t-button theme="primary" bind:click="executeAutoAssign">执行分配</t-button>
      </view>
    </view>
  </t-popup>

  <!-- 筛选弹窗 -->
  <t-popup 
    visible="{{filterVisible}}" 
    placement="bottom"
    bind:visible-change="handleFilterChange"
  >
    <view class="filter-dialog">
      <view class="dialog-header">
        <text class="dialog-title">筛选条件</text>
        <t-icon name="close" size="48rpx" bindtap="closeFilter" />
      </view>
      
      <view class="dialog-content">
        <view class="filter-group">
          <text class="filter-label">优先级</text>
          <t-checkbox-group 
            value="{{filterPriority}}"
            bind:change="onFilterPriorityChange"
          >
            <t-checkbox value="urgent" label="紧急" />
            <t-checkbox value="high" label="高" />
            <t-checkbox value="normal" label="普通" />
            <t-checkbox value="low" label="低" />
          </t-checkbox-group>
        </view>
        
        <view class="filter-group">
          <text class="filter-label">问题类型</text>
          <t-checkbox-group 
            value="{{filterType}}"
            bind:change="onFilterTypeChange"
          >
            <t-checkbox value="hardware" label="硬件故障" />
            <t-checkbox value="software" label="软件问题" />
            <t-checkbox value="network" label="网络故障" />
            <t-checkbox value="account" label="账号权限" />
            <t-checkbox value="other" label="其他" />
          </t-checkbox-group>
        </view>
        
        <view class="filter-group">
          <text class="filter-label">等待时间</text>
          <t-radio-group 
            value="{{filterWaitTime}}"
            bind:change="onFilterWaitTimeChange"
          >
            <t-radio value="all" label="全部" />
            <t-radio value="30" label="30分钟内" />
            <t-radio value="60" label="1小时内" />
            <t-radio value="120" label="2小时内" />
            <t-radio value="over120" label="超过2小时" />
          </t-radio-group>
        </view>
      </view>
      
      <view class="dialog-actions">
        <t-button theme="default" bind:click="resetFilter">重置</t-button>
        <t-button theme="primary" bind:click="applyFilter">应用</t-button>
      </view>
    </view>
  </t-popup>
</view>