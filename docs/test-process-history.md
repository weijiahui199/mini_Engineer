# 处理历史功能测试指南

## 测试准备

### 1. 访问测试页面
- 打开小程序
- 进入"我的"页面
- 滚动到底部，找到"历史功能测试"入口
- 点击进入测试页面

### 2. 测试页面功能说明
- **开始完整测试**：自动运行完整的测试流程
- **清除测试数据**：删除测试创建的工单

## 自动测试流程

点击"开始完整测试"后，系统将自动执行以下步骤：

### 测试步骤顺序
1. **创建工单** - 验证初始历史记录
2. **接单处理** - 验证接单历史记录
3. **暂停处理** - 验证暂停历史记录
4. **继续处理** - 验证继续历史记录
5. **退回工单** - 验证退回历史记录（重点：包含退回原因）
6. **重新接单** - 验证再次接单历史
7. **解决工单** - 验证解决历史记录（包含解决方案）

### 重点验证项

#### 1. 退回原因记录（最重要）
- 系统会自动填写退回原因："需要网络管理员权限才能修改核心交换机配置"
- 检查历史记录中是否正确显示退回原因
- 退回原因应该用红色背景框突出显示

#### 2. 历史记录完整性
- 每个操作都应该生成对应的历史记录
- 历史记录应包含：
  - 操作类型（action）
  - 操作人（operator）
  - 操作时间（timestamp）
  - 操作描述（description）
  - 原因（reason，仅退回有）

#### 3. 数据结构验证
```javascript
processHistory: [
  {
    id: "ph_时间戳",
    action: "rejected",
    operator: "工程师名称",
    operatorId: "openid_xxx",
    timestamp: "ISO时间格式",
    description: "退回工单",
    reason: "退回原因内容"
  }
]
```

## 测试结果判断

### ✅ 成功标志
- 所有测试项显示绿色"✅"标记
- 历史记录条数正确（应该有7-8条）
- 退回原因正确显示并突出
- 时间线按顺序排列

### ❌ 失败标志
- 出现红色"❌"错误提示
- 历史记录缺失
- 退回原因未记录或显示错误
- 操作失败无法继续

## 手动验证步骤

如果需要手动验证，可以按照以下步骤：

### 1. 创建新工单
- 进入工单列表
- 点击新建工单
- 填写必要信息并提交

### 2. 查看数据库
在微信开发者工具中：
- 打开云开发控制台
- 进入数据库
- 找到 tickets 集合
- 查看最新工单的 processHistory 字段

### 3. 验证历史记录
检查 processHistory 数组中是否包含：
- created 记录（创建时）
- accepted 记录（接单时）
- rejected 记录（退回时，必须包含 reason 字段）
- resolved 记录（解决时）

## 常见问题

### Q1: 测试失败怎么办？
1. 检查云函数是否部署成功
2. 查看控制台错误日志
3. 确认用户权限（需要工程师或经理权限）

### Q2: 历史记录为空？
1. 检查云函数中是否正确使用 `db.command.push()`
2. 确认事务是否正常提交
3. 查看数据库中是否有 processHistory 字段

### Q3: 退回原因未显示？
1. 检查 rejectTicket 函数中是否记录 reason
2. 验证前端是否正确读取 reason 字段
3. 确认样式是否正确应用（红色背景框）

## 测试完成后

1. **清理测试数据**：点击"清除测试数据"删除测试工单
2. **查看实施报告**：参考 `/docs/process-history-implementation.md`
3. **准备第二阶段**：前端展示实现

## 预期测试时间

- 自动测试：约10秒完成
- 手动验证：约5分钟
- 完整测试：约15分钟

## 联系支持

如遇到问题，请检查：
- 云函数日志
- 浏览器控制台
- 数据库记录

---

*测试版本：v1.0*  
*更新日期：2025-08-17*