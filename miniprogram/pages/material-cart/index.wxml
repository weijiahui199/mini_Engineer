<!-- 申领车页面 -->
<view class="cart-page">
  <!-- 固定顶部 -->
  <view class="cart-header">
    <view class="header-content">
      <text class="header-title">申领车（{{cartItems.length}}）</text>
    </view>
  </view>

  <!-- 提示信息栏 -->
  <view class="info-banner">
    <image src="/assets/icons/system/info_filled.png" class="info-icon" />
    <text class="info-text">提交申领时可选择关联工单，方便耗材追踪</text>
  </view>

  <!-- 滚动内容区 -->
  <scroll-view class="cart-body" scroll-y="true" enhanced="true" show-scrollbar="false">
    <!-- 全选栏 -->
    <view class="select-all-bar" wx:if="{{cartItems.length > 0}}">
      <view class="select-all-left" bindtap="toggleSelectAll">
        <view class="custom-checkbox {{selectAll ? 'checked' : ''}}">
          <image wx:if="{{selectAll}}" src="/assets/icons/business/check_selected.png" class="check-icon" />
        </view>
        <text class="select-all-text">全选</text>
      </view>
      <view class="clear-cart-btn" bindtap="clearAllCart">
        <image src="/assets/icons/business/delete_all.png" class="clear-cart-icon" />
      </view>
    </view>

    <!-- 申领清单 -->
    <view class="cart-list" wx:if="{{cartItems.length > 0}}">
      <t-swipe-cell 
        wx:for="{{cartItems}}" 
        wx:key="cartKey"
        bind:click="onSwipeAction"
        data-index="{{index}}">
        <view slot="right" class="swipe-delete-btn">
          <image src="/assets/icons/business/delete.png" class="swipe-delete-icon" />
        </view>
        <view class="cart-item {{item.stockWarning ? 'warning-border' : ''}}">
          <!-- 选择框 -->
          <view class="custom-checkbox {{item.selected ? 'checked' : ''}}" 
                bindtap="toggleSelect" 
                data-index="{{index}}">
            <image wx:if="{{item.selected}}" src="/assets/icons/business/check_selected.png" class="check-icon" />
          </view>
          
          <!-- 产品图片 -->
          <t-image 
            class="item-image" 
            src="{{item.image || placeholderImage}}" 
            mode="aspectFill"
            lazy
          />
          
          <!-- 产品信息 -->
          <view class="item-content">
            <view class="item-header">
              <text class="item-title">{{item.materialName}}</text>
              <text class="item-variant">{{item.variantLabel}}</text>
            </view>
            
            <view class="item-footer">
              <!-- 库存信息 -->
              <view class="stock-info">
                <text class="stock-label {{item.stockWarning ? 'warning-text' : ''}}">
                  库存: {{item.stock}}{{item.unit}}
                </text>
                <text wx:if="{{item.stockWarning}}" class="stock-warning">
                  ⚠️ 库存不足，建议减少数量
                </text>
              </view>
              
              <!-- 数量步进器 -->
              <t-stepper 
                value="{{item.quantity}}"
                min="{{1}}"
                max="{{item.stock}}"
                bind:change="onQuantityChange"
                data-index="{{index}}"
                theme="filled"
                size="small"
              />
            </view>
          </view>
        </view>
      </t-swipe-cell>
    </view>

    <!-- 空状态 -->
    <view wx:else class="empty-state">
      <t-empty image="/assets/icons/business/cart.png" description="申领车还是空的">
        <view slot="action">
          <t-button theme="primary" size="medium" bindtap="goToMaterialList">去选耗材</t-button>
        </view>
      </t-empty>
    </view>

    <!-- 关联工单 -->
    <view class="section-card" wx:if="{{cartItems.length > 0}}">
      <text class="section-title">关联工单</text>
      
      <!-- 已选工单 -->
      <view wx:if="{{selectedTicket}}" class="ticket-selected">
        <view class="ticket-card">
          <view class="ticket-header">
            <text class="ticket-no">{{selectedTicket.ticketNo}}</text>
            <t-tag theme="{{selectedTicket.status === 'processing' ? 'success' : 'warning'}}" size="small">
              {{selectedTicket.statusText}}
            </t-tag>
          </view>
          <text class="ticket-title">{{selectedTicket.title}}</text>
          <text class="ticket-submitter">提交人: {{selectedTicket.submitterName}}</text>
        </view>
        <image src="/assets/icons/common/close.png" class="remove-icon" bindtap="removeSelectedTicket" />
      </view>
      
      <!-- 未选工单 -->
      <view wx:else class="ticket-empty">
        <!-- 快速选择 -->
        <view class="quick-tickets" wx:if="{{recentTickets.length > 0}}">
          <text class="quick-label">快速选择：</text>
          <view class="quick-ticket-list">
            <view wx:for="{{recentTickets}}" 
                  wx:key="_id" 
                  class="quick-ticket-card {{selectedTicket._id === item._id ? 'quick-ticket-active' : ''}}"
                  data-ticket="{{item}}"
                  bindtap="quickSelectTicket">
              <!-- 左侧选中框 -->
              <view class="ticket-checkbox {{selectedTicket._id === item._id ? 'checked' : ''}}">
                <image wx:if="{{selectedTicket._id === item._id}}" 
                       src="/assets/icons/business/check_selected.png" 
                       class="check-icon" />
              </view>
              
              <!-- 工单图标 -->
              <view class="ticket-icon-wrapper">
                <image src="/assets/icons/business/ticket.png" class="ticket-icon" />
              </view>
              
              <!-- 工单信息 -->
              <view class="ticket-info">
                <view class="ticket-main">
                  <text class="ticket-title-text">{{item.title}}</text>
                  <t-tag size="small" theme="{{item.status === 'processing' ? 'success' : 'warning'}}">
                    {{item.statusText}}
                  </t-tag>
                </view>
                <view class="ticket-meta">
                  <text class="ticket-no-text">{{item.ticketNo}}</text>
                  <text class="ticket-separator">|</text>
                  <text class="ticket-submitter-text">报修人: {{item.submitterName}}</text>
                </view>
              </view>
            </view>
          </view>
        </view>
        
        <t-button 
          theme="primary" 
          size="medium" 
          bindtap="selectTicket">
          <image slot="icon" src="/assets/icons/common/plus.png" class="btn-icon" />
          选择更多
        </t-button>
      </view>
    </view>

    <!-- 备注 -->
    <view class="section-card" wx:if="{{cartItems.length > 0}}">
      <text class="section-title">备注信息</text>
      <view class="remark-wrapper">
        <t-textarea 
          placeholder="请输入备注信息（选填）"
          value="{{note}}"
          maxlength="{{200}}"
          bind:change="onNoteInput"
          indicator
          t-class="custom-textarea"
          t-class-indicator="custom-indicator"
        />
      </view>
    </view>

    <!-- 申领须知 -->
    <view class="notice-card" wx:if="{{cartItems.length > 0}}">
      <t-notice-bar 
        visible="{{true}}"
        prefixIcon="{{false}}"
        content="申领须知：1. 申领提交后将直接扣减库存，无需审批 2. 请根据实际需求适量申领，避免浪费 3. 如有紧急需求，请联系管理员"
        theme="info"
      />
    </view>

    <!-- 底部占位 -->
    <view class="bottom-safe-area"></view>
  </scroll-view>

  <!-- 固定底部结算栏 -->
  <view class="cart-footer" wx:if="{{cartItems.length > 0}}">
    <view class="footer-content">
      <view class="footer-info">
        <text class="selected-text">已选: {{selectedCount}}件</text>
        <!-- Manager可以看总价 -->
        <view wx:if="{{isManager}}" class="price-info">
          <text class="price-label">合计:</text>
          <text class="price-value">¥{{totalPrice}}</text>
        </view>
      </view>
      
      <view class="footer-actions">
        <t-button 
          theme="default" 
          variant="outline" 
          size="medium"
          class="continue-btn"
          bindtap="goToMaterialList">
          继续添加
        </t-button>
        <t-button 
          theme="primary" 
          size="medium"
          class="submit-btn"
          disabled="{{selectedCount === 0}}"
          bindtap="submitRequisition">
          提交申领
        </t-button>
      </view>
    </view>
  </view>

  <!-- 工单选择弹窗 -->
  <t-popup 
    visible="{{showTicketSelector}}"
    placement="bottom"
    bind:visible-change="onTicketPopupChange"
    close-on-overlay-click="{{true}}">
    <view class="ticket-selector">
      <!-- 弹窗头部 -->
      <view class="selector-header">
        <text class="selector-title">选择关联工单</text>
        <image src="/assets/icons/common/close.png" class="close-icon" bindtap="closeTicketSelector" />
      </view>
      
      <!-- 搜索栏 -->
      <view class="selector-search">
        <view class="custom-search">
          <image src="/assets/icons/common/search.png" class="search-icon" />
          <input 
            class="search-input"
            value="{{ticketSearchKeyword}}"
            placeholder="搜索工单号、客户、问题"
            bindinput="onTicketSearch"
            confirm-type="search"
          />
          <image 
            wx:if="{{ticketSearchKeyword}}"
            src="/assets/icons/common/empty.png" 
            class="clear-icon"
            bindtap="clearSearch"
          />
        </view>
      </view>
      
      <!-- Tab切换 -->
      <t-tabs 
        value="{{ticketTab}}"
        bind:change="onTicketTabChange"
        swipeable="{{false}}">
        <t-tab-panel value="my" label="我的工单" />
        <t-tab-panel value="recent" label="最近工单" />
        <t-tab-panel value="all" label="全部工单" />
      </t-tabs>
      
      <!-- 工单列表 -->
      <scroll-view class="ticket-list" scroll-y>
        <!-- 不关联选项 -->
        <view class="ticket-select-item" bindtap="selectTicketItem" data-ticket-id="">
          <view class="custom-checkbox {{!selectedTicketId ? 'checked' : ''}}">
            <image wx:if="{{!selectedTicketId}}" src="/assets/icons/business/check_selected.png" class="check-icon" />
          </view>
          <view class="ticket-item-content">
            <text class="ticket-item-title">不关联工单</text>
            <text class="ticket-item-note">独立申领，不计入工单成本</text>
          </view>
        </view>
        
        <!-- 工单项 -->
        <view class="ticket-select-item" 
              wx:for="{{filteredTickets}}" 
              wx:key="_id"
              bindtap="selectTicketItem"
              data-ticket-id="{{item._id}}">
          <view class="custom-checkbox {{selectedTicketId === item._id ? 'checked' : ''}}">
            <image wx:if="{{selectedTicketId === item._id}}" src="/assets/icons/business/check_selected.png" class="check-icon" />
          </view>
          <view class="ticket-item-content">
            <view class="ticket-item-header">
              <text class="ticket-item-no">{{item.ticketNo}}</text>
              <t-tag theme="{{item.status === 'processing' ? 'success' : 'warning'}}" size="small">
                {{item.statusText}}
              </t-tag>
            </view>
            <text class="ticket-item-title">{{item.title}}</text>
            <text class="ticket-item-desc">提交人: {{item.submitterName}} · {{item.createTimeText}}</text>
          </view>
        </view>
        
        <!-- 暂无工单 -->
        <view wx:if="{{filteredTickets.length === 0}}" class="no-result">
          <t-empty description="{{isManager ? '暂无工单' : '暂无您负责的工单，请先接单'}}" />
        </view>
      </scroll-view>
      
      <!-- 确认按钮 -->
      <view class="selector-footer">
        <t-button theme="primary" block bindtap="confirmTicketSelection">
          确认选择
        </t-button>
      </view>
    </view>
  </t-popup>

</view>