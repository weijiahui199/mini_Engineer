<!-- 工单列表页面 -->
<view class="ticket-list-container">
  <!-- 搜索栏 -->
  <view class="search-container">
    <t-search
      model:value="{{searchKeyword}}"
      placeholder="搜索工单号、标题、提交人..."
      bind:change="onSearchChange"
      bind:submit="onSearch"
    />
  </view>

  <!-- 筛选栏 - 双抽屉式设计 -->
  <view class="filter-container-drawer {{layoutMode}}-layout">
    <!-- 主筛选栏：状态和时间抽屉 -->
    <view class="filter-main-row">
      <!-- 状态选择按钮（抽屉式） -->
      <view class="status-selector-wrapper">
        <view 
          class="status-selector-btn {{statusDropdownOpen ? 'open' : ''}} {{currentFilter !== 'all' ? 'active' : ''}}"
          bindtap="toggleStatusDropdown"
        >
          <view class="btn-content">
            <text class="btn-icon">{{currentFilter === 'urgent' ? '🔥' : '📊'}}</text>
            <text class="btn-text">{{currentFilter === 'all' ? '全部' : currentFilter === 'pending' ? '待处理' : currentFilter === 'processing' ? '处理中' : currentFilter === 'resolved' ? '已解决' : currentFilter === 'closed' ? '已关闭' : currentFilter === 'urgent' ? '紧急' : '全部'}}</text>
          </view>
          <text class="dropdown-icon">▼</text>
        </view>
        
        <!-- 状态选择下拉面板 -->
        <view class="status-dropdown-panel" wx:if="{{statusDropdownOpen}}" catchtap="preventClose">
          <view 
            wx:for="{{filterOptions}}" 
            wx:key="value"
            class="status-option {{item.value === currentFilter ? 'selected' : ''}} {{item.value === 'urgent' ? 'urgent-option' : ''}}"
            bindtap="selectStatus"
            data-value="{{item.value}}"
          >
            <text class="option-label">
              {{item.value === 'urgent' ? '🔥 ' : ''}}
              {{item.label}}
            </text>
            <text class="option-count" wx:if="{{item.count > 0}}">({{item.count}})</text>
          </view>
        </view>
      </view>
    
      
      <!-- 时间选择按钮（抽屉式） -->
      <view class="time-selector-wrapper" wx:if="{{currentFilter !== 'closed'}}">
        <view 
          class="time-selector-btn {{timeDropdownOpen ? 'open' : ''}} {{timeRangeFilter !== 'month' ? 'active' : ''}}"
          bindtap="toggleTimeDropdown"
        >
          <view class="btn-content">
            <text class="btn-icon">📅</text>
            <text class="btn-text">{{timeRangeFilter === 'week' ? '近7天' : timeRangeFilter === 'month' ? '近1月' : timeRangeFilter === 'halfYear' ? '近6月' : timeRangeFilter === 'year' ? '近1年' : timeRangeFilter === 'overYear' ? '一年以上' : '近1月'}}</text>
          </view>
          <text class="dropdown-icon">▼</text>
        </view>
        
        <!-- 时间选择下拉面板 -->
        <view class="time-dropdown-panel" wx:if="{{timeDropdownOpen}}" catchtap="preventClose">
          <view 
            wx:for="{{timeRangeOptions}}" 
            wx:key="value"
            class="time-option {{item.value === timeRangeFilter ? 'selected' : ''}}"
            bindtap="selectTimeRange"
            data-value="{{item.value}}"
          >
            {{item.label}}
          </view>
        </view>
      </view>
    </view>
    
    <!-- 已关闭工单提示 -->
    <view class="closed-tip" wx:if="{{currentFilter === 'closed'}}">
      <text class="tip-text">💡 下滑自动加载更早的已关闭工单（当前：{{closedTimeRange === 'month' ? '近1月' : closedTimeRange === 'halfYear' ? '近6月' : closedTimeRange === 'year' ? '近1年' : '全部'}}）</text>
    </view>
  </view>

  <!-- 工单列表 -->
  <scroll-view 
    scroll-y="{{true}}"
    class="ticket-scroll"
    bindscrolltolower="onLoadMore"
    refresher-enabled="{{true}}"
    refresher-triggered="{{refreshing}}"
    bindrefresherrefresh="onPullDownRefresh"
    enhanced="{{true}}"
    bounces="{{true}}"
    show-scrollbar="{{false}}"
  >
    <view class="ticket-list" wx:if="{{ticketList.length > 0}}">
      <t-swipe-cell 
        wx:for="{{ticketList}}" 
        wx:key="id"
      >
        <view 
          class="ticket-card {{item.priority === 'urgent' ? 'urgent-border' : ''}} {{!item.assigneeOpenid && item.status === 'pending' ? 'pool-ticket' : ''}} {{item.assigneeOpenid && item.assigneeOpenid !== openid ? 'taken' : ''}} {{item.assigneeOpenid === openid ? 'my-ticket' : ''}}"
        >
          <!-- 可点击区域 - 点击查看详情 -->
          <view class="card-clickable" bindtap="onTicketClick" data-ticket="{{item}}" data-index="{{index}}">
            <!-- 工单头部 -->
            <view class="card-header">
              <view class="header-left">
                <view class="priority-dot priority-{{item.priority}}"></view>
                <text class="ticket-no">#{{item.ticketNo}}</text>
              </view>
              <view class="header-right">
                <t-tag 
                  theme="{{item.status === 'paused' ? 'warning' : item.status === 'pending' ? 'warning' : item.status === 'processing' ? 'primary' : item.status === 'resolved' ? 'success' : 'default'}}"
                  variant="light"
                  size="small"
                >
                  {{statusText[item.status]}}
                </t-tag>
                <t-tag 
                  wx:if="{{item.priority === 'urgent'}}"
                  theme="danger"
                  variant="light"
                  size="small"
                >
                  紧急
                </t-tag>
              </view>
            </view>
            
            <!-- 工单内容 -->
            <view class="card-content">
              <view class="content-header">
                <text class="ticket-title">{{item.title}}</text>
                <view class="assignee-tag" wx:if="{{item.assigneeName}}">
                  <image class="assignee-icon" src="/assets/icons/engineer.png" mode="aspectFit"/>
                  <text class="assignee-text">{{item.assigneeName}}</text>
                </view>
              </view>
              <view class="ticket-category">
                <image class="category-icon" src="/assets/icons/category.png" mode="aspectFit"/>
                <text class="category-text">{{item.category}}</text>
              </view>
            </view>
            
            <!-- 工单信息 - 2列布局 -->
            <view class="card-info">
              <view class="info-row">
                <view class="info-item" wx:if="{{item.company}}">
                  <image class="info-icon" src="/assets/icons/company.png" mode="aspectFit"/>
                  <text class="info-text">{{item.company}}</text>
                </view>
                <view class="info-item">
                  <image class="info-icon" src="/assets/icons/location.png" mode="aspectFit"/>
                  <text class="info-text">{{item.location}}</text>
                </view>
              </view>
              <view class="info-row">
                <view class="info-item">
                  <image class="info-icon" src="/assets/icons/user.png" mode="aspectFit"/>
                  <text class="info-text">{{item.submitter}}</text>
                </view>
                <view class="info-item">
                  <image class="info-icon" src="/assets/icons/time.png" mode="aspectFit"/>
                  <text class="info-text">{{item.createTimeDisplay}}</text>
                </view>
              </view>
            </view>
          </view>
          <!-- 结束可点击区域 -->
          
          <!-- 操作按钮 - 独立于可点击区域 -->
          <view class="card-actions">
            
            <!-- 场景1：未分配工单 - 显示开始处理按钮 -->
            <button 
              wx:if="{{userRoleGroup === '工程师' && item.realStatus === 'pending' && !item.assigneeOpenid}}"
              class="custom-btn btn-primary"
              catchtap="acceptTicketSafely"
              data-id="{{item.id}}"
            >
              开始处理
            </button>
            
            <!-- 场景2：暂停状态的工单 - 显示继续处理按钮 -->
            <button 
              wx:elif="{{item.status === 'paused' && item.assigneeOpenid === openid}}"
              class="custom-btn btn-continue"
              catchtap="continueProcessing"
              data-id="{{item.id}}"
            >
              继续处理
            </button>
            
            <!-- 场景3：我的工单(processing状态) - 显示查看详情和完成工单两个按钮 -->
            <block wx:elif="{{item.assigneeOpenid === openid && item.status === 'processing'}}">
              <button 
                class="custom-btn btn-detail"
                catchtap="navigateToDetail"
                data-id="{{item.id}}"
              >
                查看详情
              </button>
              <button 
                class="custom-btn btn-complete"
                catchtap="completeTicket"
                data-id="{{item.id}}"
              >
                完成工单
              </button>
            </block>
            
            <!-- 场景3：我的工单(已解决) - 显示查看详情 -->
            <button 
              wx:elif="{{item.assigneeOpenid === openid && item.status === 'resolved'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              查看详情
            </button>
            
            <!-- 场景3.5：已关闭工单 - 显示已关闭标签 -->
            <t-tag
              wx:elif="{{item.status === 'closed'}}"
              theme="default"
              variant="outline"
              size="medium"
            >
              已关闭
            </t-tag>
            
            <!-- 场景4：他人的工单 - 显示已被接单文字 -->
            <text 
              wx:elif="{{userRoleGroup === '工程师' && item.assigneeOpenid && item.assigneeOpenid !== openid}}"
              class="status-hint"
            >
              已被接单
            </text>
            
            <!-- 场景5：经理角色 - 始终显示查看详情 -->
            <button 
              wx:elif="{{userRoleGroup === '经理'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              查看详情
            </button>
            
            <!-- 场景6：普通用户查看自己提交的工单 -->
            <button 
              wx:elif="{{userRoleGroup === '用户'}}"
              class="custom-btn btn-default"
              catchtap="navigateToDetail"
              data-id="{{item.id}}"
            >
              查看详情
            </button>
          </view>
        </view>
      </t-swipe-cell>
    </view>
    
    <!-- 空状态 -->
    <t-empty 
      wx:else
      icon="inbox"
      description="{{emptyText}}"
    >
      <t-button 
        slot="action" 
        theme="primary"
        bind:click="onRefresh"
      >
        刷新列表
      </t-button>
    </t-empty>
    
    <!-- 加载更多 -->
    <view class="load-more" wx:if="{{hasMore && ticketList.length > 0}}">
      <t-loading theme="dots" loading="{{loadingMore}}" text="加载中..." />
    </view>
  </scroll-view>

</view>